<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />

  <!-- Disable caching so updates always load fresh -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Zero-Proof Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA manifest + icons -->
  <link rel="manifest" href="/sipsoberleaflet/manifest.json">
  <meta name="theme-color" content="#202329">
  <link rel="apple-touch-icon" href="/sipsoberleaflet/icons/icon-192.png">
  <link rel="icon" href="/sipsoberleaflet/icons/icon-192.png">

  <!-- Leaflet CSS (latest CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin="anonymous"
  />

  <style>
    /* =========================
       APP-ONLY MAP LAYOUT
       ========================= */

    :root {

  /* mobile panel heights (used for dynamic map resizing) */
  --panel-collapsed: 18vh;
  --panel-expanded: 38vh;
}

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      overscroll-behavior: none;

      /* Cleaner, more modern iOS font stack */
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        sans-serif;

      /* Softer, professional text color */
      background: #ffffff;
      color: #1c1c1e;

      /* Makes text look smoother on iPhone */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;

      line-height: 1.45;
      font-size: 12px; /* smaller base type */
    }

    /* --- Top filters bar: floating pill --- */
    #filters {
      position: fixed;
      top: 10px;
      left: 12px;
      right: 12px;
      z-index: 3100;

      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;

      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 999px; /* pill shape */
      border: 1px solid #e2e4ec;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.22);

      backdrop-filter: none;
    }

    /* --- Top bar search (after Go) --- */
    .ss-searchTop{
      display: flex;
      align-items: center;
      gap: 8px;

      height: 32px;
      padding: 0 10px;

      background: #f2f2f7;
      border: 1px solid #ccc;
      border-radius: 999px;

      font-size: 12px;
      min-width: 140px;
    }

    .ss-searchIcon{
      font-size: 12px;
      opacity: 0.6;
    }

    #searchTopInput{
      border: 0;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 16px;
      min-width: 60px;
    }

    #searchTopInput::-webkit-search-cancel-button{
      -webkit-appearance: none;
    }
    
    #searchTopClear{
      border: 0;
      background: transparent;
      font-size: 16px;
      line-height: 1;
      opacity: 0.6;
      cursor: pointer;
      padding: 0;
    }

    /* =========================
   TOP SEARCH TOGGLE
   ========================= */

  #searchToggle{
    border: 1px solid #ccc;
    background: #f2f2f7;
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 16px;
    cursor: pointer;
    color: #2f3b69;
  }

  /* collapsible row */
  #searchTopRow{
    display: none;
    width: 100%;
  }

  #searchTopRow.is-open{
    display: block;
  }

  .ss-searchTop{
    width: 100%;
  }
    
    .dropdown > button {
      background: #f2f2f7;
      border: 1px solid #ccc;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      color: #2f3b69;
    }

    /* =========================
   Dropdown menus: show ~4 items + scroll
   ========================= */

.dropdown .menu {
  max-height: 180px;          
  overflow-y: auto;
  overflow-x: hidden;

  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
    
    #goBtn {
      background: #202329;
      color: white;
      border: 0;
      border-radius: 10px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
    }

    /* Main map area ‚Äì fills behind filters and above bottom panel */
    #map {
      position: absolute;
      top: 0; /* ‚úÖ map goes all the way to the top; filters float above */
      left: 0;
      right: 0;
      bottom: 0;
      height: auto;
      z-index: 1;
    }

    /* --- Dropdown menus (hide/show) --- */
    .dropdown {
      position: relative;
    }

    .dropdown .menu {
      display: none;
      position: absolute;
      top: 120%;
      left: 0;

      background: #ffffff;
      border: 1px solid #e2e4ec;
      border-radius: 16px;
      padding: 10px 12px;
      width: 200px;
      z-index: 3000;

      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.16);
    }

    .dropdown.open .menu {
      display: block;
    }

    .dropdown .row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 3px 0;
      margin: 0;
      font-size: 12px;
      color: #1c1c1e;
    }

   
    /* --- Bottom results panel floats above the map --- */
#bottom-panel {
  position: fixed;
  left: 12px;
  right: 12px;
  bottom: 0;

  /* collapsed by default (peek) */
  height: var(--panel-collapsed);

  background: rgba(255, 255, 255, 0.72);
  backdrop-filter: blur(12px); /* iOS glass effect */
  -webkit-backdrop-filter: blur(12px);
  border-radius: 22px 22px 0 0;
  box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.10);

  padding: 10px 18px calc(14px + env(safe-area-inset-bottom));
  z-index: 2001;

  /* animation + behavior */
  transition: height 220ms ease;
  overflow-y: hidden; /* prevent scroll when collapsed */
}

/* expanded state */
#bottom-panel.expanded {
  height: var(--panel-expanded);
  overflow-y: auto;
}

/* results list inside the panel */
#results {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px;
}


/* --- Panel toggle handle (tap to expand/collapse) --- */
#panel-toggle {
  width: 100%;
  border: 0;
  background: transparent;
  padding: 6px 0 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

#panel-toggle .handle {
  width: 44px;
  height: 5px;
  border-radius: 999px;
  background: rgba(0, 0, 0, 0.18);
}

#panel-toggle .label {
  font-size: 12px;
  font-weight: 600;
  opacity: 0.6;
}
    
    /* --- Results count (under active filters) --- */
    #results-count {
      font-size: 13px;
      font-weight: 500;
      color: #5f6368;
      margin: 6px 10px 6px;   /* left aligns with #results padding */
      letter-spacing: 0.01em;
    }


    /* --- Bottom panel card styling --- */
    .card {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
      font-size: 12px;
      color: #333;
      line-height: 1.35;
    }

    .card:last-child {
      border-bottom: none;
    }

    /* Venue name */
    .card-name {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 0;
      color: #111;
      cursor: pointer;
    }

    .card-name:hover {
      text-decoration: underline;
    }

    #bottom-panel .card p {
      margin: 0;
      line-height: 1.32;
    }

    #bottom-panel .card a {
      font-size: 12px;
      font-weight: 500;
      color: #2f3b69;
      text-decoration: underline;
    }

    /* Move Leaflet zoom controls to bottom-right */
    .leaflet-control-zoom {
      bottom: 20px;
      right: 20px;
      left: auto !important;
      top: auto !important;
    }

    .leaflet-top.leaflet-left {
      top: auto !important;
      left: auto !important;
      right: 16px !important;
      bottom: 24px !important;
      z-index: 3200 !important; /* above filters */
    }

    /* ============================
       ACTIVE FILTERS ABOVE RESULTS
       ============================ */

    .active-filters {
      display: none; /* JS switches to flex when filters are active */
      flex-wrap: wrap;
      gap: 6px;
      margin: 0 0 10px;
      padding: 4px 4px 6px;
      position: sticky; /* stays visible while panel scrolls */
      top: 0;
      z-index: 2;
      background: #fff;
    }

    .filter-pill {
      display: inline-flex;
      align-items: center;
      background: #f2f2f2;
      border-radius: 14px;
      padding: 4px 10px;
      font-size: 13px;
      color: #333;
    }

    .filter-pill-x {
  margin-left: 6px;
  font-weight: 600;
  cursor: pointer;
}


/* Small tweak for phones only (optional) */
@media (max-width: 720px) {
  #filters {
    top: 10px;
  }
}

/* Favorite star */
.fav-btn{
  background: none;
  border: 0;
  padding: 6px;
  cursor: pointer;
  font-size: 22px;
  line-height: 1;
  color: #b9b9b9;
}

.fav-btn.is-fav{
  color: #202239;
}

    .card-top{
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
}

    
/* =========================
   MAP POPUP (Leaflet)
   ========================= */

.leaflet-popup-content-wrapper {
  border-radius: 18px !important;
  box-shadow: 0 16px 40px rgba(0,0,0,0.18) !important;
  padding: 0 !important;
}

.leaflet-popup-content {
  margin: 0 !important;
  width: auto !important;
  max-width: none !important;
}

/* Simple popup (text-first) */
.ss-popup--simple {
  padding: 12px 14px;
  min-width: 220px;
  max-width: 280px;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
  color: #1c1c1e;
}

/* Popup venue image */
.ss-popup-img{
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 14px;
  display: block;
  margin-bottom: 10px;
}

.ss-popup--simple .ss-popup-title {
  font-size: 12px;
  font-weight: 800;
  margin-bottom: 4px;
}

.ss-popup--simple .ss-popup-meta {
  font-size: 11px;
  color: #6b6f82;
  line-height: 1.3;
  margin-bottom: 6px;
}

.ss-popup--simple .ss-popup-tags {
  font-size: 11px;
  color: #6b6f82;
  margin-bottom: 8px;
  
  line-height: 1.25;
  max-height: calc(1.25em * 2);
  overflow: hidden;
}

.ss-popup--simple .ss-popup-links {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.ss-popup--simple .ss-popup-link {
  font-size: 11px;
  color: #6b6f82;
  text-decoration: underline;
  -webkit-tap-highlight-color: transparent;
}

.ss-popup--simple .ss-popup-link:active {
  opacity: 0.8;
}
    
/* Make the popup close "x" cleaner */
.leaflet-container a.leaflet-popup-close-button {
  width: 32px !important;
  height: 32px !important;
  font-size: 20px !important;
  line-height: 32px !important;
  color: #9aa0b5 !important;
}

/* =========================
   SIP SOBER ‚Äî MAP ONBOARDING BANNER
   ========================= */

.ss-onboard {
  position: fixed;
  left: 12px;
  right: 12px;
  top: 140px; /* keep where it is now */
  z-index: 5000;

  opacity: 0;
  transform: translateY(8px);
  transition: opacity 220ms ease, transform 220ms ease;

  pointer-events: none;
}

.ss-onboard.is-visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.ss-onboard[hidden] {
  display: none !important;
}

.ss-onboard__content {
  pointer-events: auto;
  background: rgba(255, 255, 255, 0.92);
  border: 1px solid rgba(32, 34, 57, 0.12);
  border-radius: 18px;
  padding: 12px 14px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.12);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
}

.ss-onboard__title {
  font-size: 14px;
  font-weight: 800;
  color: #202239;
  margin-bottom: 4px;
}

.ss-onboard__text {
  font-size: 13px;
  line-height: 1.3;
  color: rgba(0,0,0,0.65);
  margin-bottom: 10px;
}

.ss-onboard__actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.ss-onboard__btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 34px;
  padding: 0 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 700;
  text-decoration: none;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.ss-onboard__btn--primary {
  border: 0;
  color: #fff;
  background: #202239;
}

.ss-onboard__btn--ghost {
  border: 1px solid rgba(32, 34, 57, 0.18);
  color: #202239;
  background: rgba(255,255,255,0.65);
}
    
</style>


  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-W6LRN7EDH7"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-W6LRN7EDH7", {
      send_page_view: true,
    });
  </script>
</head>

<body>

<!-- ===== Sip Sober: one-time onboarding banner ===== -->
<div id="ss-onboard" class="ss-onboard" role="status" aria-live="polite" hidden>
  <div class="ss-onboard__content">
    <div class="ss-onboard__title">Explore &amp; save</div>
    <div class="ss-onboard__text">
      Filter by <b>brand</b> or <b>neighborhood</b>, then tap <b>‚òÖ</b> to save favorites.
    </div>

    <div class="ss-onboard__actions">
      <button id="ss-onboard-ok" class="ss-onboard__btn ss-onboard__btn--primary" type="button">
        Got it
      </button>

    </div>
  </div>
</div>

  
 <!-- TOP CONTROLS (filters + Go) -->
<div id="filters" class="topbar filterbar">

  <div class="dropdown" id="brandDD">
    <button type="button" aria-expanded="false">Brands ‚ñæ</button>
    <div class="menu" role="menu">

      <div class="row">
        <input id="brand-seedlip" type="checkbox" value="Seedlip" />
        <label for="brand-seedlip">Seedlip</label>
      </div>

      <div class="row">
        <input id="brand-ritual" type="checkbox" value="Ritual Zero Proof" />
        <label for="brand-ritual">Ritual Zero Proof</label>
      </div>

      <div class="row">
        <input id="brand-lyres" type="checkbox" value="Lyre's" />
        <label for="brand-lyres">Lyre's</label>
      </div>

      <div class="row">
        <input id="brand-agrestis" type="checkbox" value="St. Agrestis" />
        <label for="brand-agrestis">St. Agrestis</label>
      </div>

      <div class="row">
        <input id="brand-aplos" type="checkbox" value="Apl√≥s" />
        <label for="brand-aplos">Apl√≥s</label>
      </div>

      <div class="row">
        <input id="brand-pathfinder" type="checkbox" value="Pathfinder" />
        <label for="brand-pathfinder">Pathfinder</label>
      </div>

      <div class="row">
        <input id="brand-curious" type="checkbox" value="Curious Elixirs" />
        <label for="brand-curious">Curious Elixirs</label>
      </div>

      <div class="row">
        <input id="brand-goodtime" type="checkbox" value="Good Time Brewing" />
        <label for="brand-goodtime">Good Time Brewing</label>
      </div>

      <div class="row">
        <input id="brand-ghia" type="checkbox" value="Ghia" />
        <label for="brand-ghia">Ghia</label>
      </div>

      <div class="row">
        <input id="brand-pentire" type="checkbox" value="Pentire" />
        <label for="brand-pentire">Pentire</label>
      </div>

      <div class="row">
        <input id="brand-athletic" type="checkbox" value="Athletic Brewing Co." />
        <label for="brand-athletic">Athletic Brewing Co.</label>
      </div>

    </div>
  </div>

  <div class="dropdown" id="neighborhoodDD">
    <button type="button" aria-expanded="false">Neighborhoods ‚ñæ</button>
    <div class="menu" role="menu">

      <div class="row">
        <input id="n-ues" type="checkbox" value="Upper East Side" />
        <label for="n-ues">Upper East Side</label>
      </div>

      <div class="row">
        <input id="n-midtown" type="checkbox" value="Midtown" />
        <label for="n-midtown">Midtown</label>
      </div>

      <div class="row">
        <input id="n-gramercy" type="checkbox" value="Gramercy" />
        <label for="n-gramercy">Gramercy</label>
      </div>

      <div class="row">
        <input id="n-chelsea" type="checkbox" value="Chelsea" />
        <label for="n-chelsea">Chelsea</label>
      </div>

      <div class="row">
        <input id="n-uws" type="checkbox" value="Upper West Side" />
        <label for="n-uws">Upper West Side</label>
      </div>

      <div class="row">
        <input id="n-fidi" type="checkbox" value="FiDi" />
        <label for="n-fidi">FiDi</label>
      </div>

      <div class="row">
        <input id="n-flatiron" type="checkbox" value="Flatiron" />
        <label for="n-flatiron">Flatiron</label>
      </div>

      <div class="row">
        <input id="n-west-village" type="checkbox" value="West Village" />
        <label for="n-west-village">West Village</label>
      </div>
      
      <div class="row">
        <input id="n-tribeca" type="checkbox" value="Tribeca" />
        <label for="n-tribeca">Tribeca</label>
      </div>

      <div class="row">
        <input id="n-soho" type="checkbox" value="SoHo" />
        <label for="n-soho">SoHo</label>
      </div>

      <div class="row">
        <input id="n-east-village" type="checkbox" value="East Village" />
        <label for="n-east-village">East Village</label>
      </div>

    </div>
  </div>

  <button id="goBtn" type="button">Go</button>

  <button
    id="searchToggle"
    type="button"
    aria-label="Search"
    aria-expanded="false"
  >
    üîç
  </button>
  
  <!-- üîç Search (TOP BAR) -->
  <div id="searchTopRow">
    <div class="ss-searchTop">
      <span class="ss-searchIcon" aria-hidden="true">‚ó¶</span>
      <input
        id="searchTopInput"
        type="search"
        placeholder="Search a venue‚Ä¶"
        autocomplete="off"
      />
      <button
        id="searchTopClear"
        type="button"
        aria-label="Clear search"
      >√ó</button>
    </div>
  </div>

</div>

  <!-- Fullscreen Map -->
  <div id="map"></div>

  <!-- Sliding Bottom Results Panel -->
  <div id="bottom-panel">

    <!-- Panel toggle handle -->
    <button id="panel-toggle" type="button" aria-expanded="false">
      <span class="handle" aria-hidden="true"></span>
      <span class="label">Show</span>
    </button>

    <div id="active-filters" class="active-filters"></div>
    <div id="results-count" class="results-count"></div>
    <div id="results"></div>

  </div>

  <!-- Leaflet JS (latest CDN) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"
  ></script>

  <script>
    /* =========================
       A) DATA
       ========================= */
    const locations = [
      { name: "Bemelman's Bar", address: "35 E 76th St, NY", lat: 40.774, lng: -73.9636, website: "https://www.rosewoodhotels.com", brand: "Ritual Zero Proof", neighborhood: "Upper East Side", imageUrl: "venue-images/bemelmans.jpeg" },
      { name: "Bar Avant (Olly Olly Market)", address: "601 W 26th St, NY", lat: 40.7498, lng: -74.0075, website: "https://ollyollymarket.com", brand: "Seedlip, St. Agrestis", neighborhood: "Chelsea", imageUrl: "venue-images/baravant.jpeg" },
      { name: "Fumo", address: "198 8th Ave, NY", lat: 40.7448, lng: -73.9809, website: "https://fumonyc.com", brand: "Seedlip, Athletic Brewing Co.", neighborhood: "Chelsea", imageUrl: "venue-images/fumochelsea.jpeg" },
      { name: "Miriam", address: "300 Amsterdam Ave, NY", lat: 40.7809, lng: -73.9797, website: "https://miriamrestaurant.com", brand: "Seedlip, Lyre's, Athletic Brewing Co.", neighborhood: "Upper West Side", imageUrl: "venue-images/miriamuws.jpeg" },
      { name: "Sarabeth's", address: "423 Amsterdam Ave, NY", lat: 40.786, lng: -73.977, website: "https://sarabethsrestaurants.com", brand: "Lyre's", neighborhood: "Upper West Side" },
      { name: "Bondurants", address: "303 E 85th St, NY", lat: 40.777, lng: -73.9518, website: "https://bondurantsnyc.com", brand: "Seedlip, Lyre's, Athletic Brewing Co.", neighborhood: "Upper East Side", imageUrl: "venue-images/bondurants.jpeg" },
      { name: "Sfoglia", address: "1402 Lexington Ave, NY", lat: 40.7835, lng: -73.9529, website: "https://sfogliarestaurant.com", brand: "Lyre's, Ritual Zero Proof, St. Agrestis, Good Time Brewing", neighborhood: "Upper East Side", imageUrl: "venue-images/sfoglia.jpeg" },
      { name: "The Blasket", address: "1085 2nd Ave, NY", lat: 40.7579, lng: -73.9635, website: "https://theblasketnyc.com", brand: "Lyre's, Athletic Brewing Co.", neighborhood: "Midtown", imageUrl: "venue-images/blasket.jpeg" },
      { name: "Rosemary's Midtown", address: "825 3rd Ave, NY", lat: 40.7559, lng: -73.9701, website: "https://rosemarysnyc.com", brand: "Lyre's, Ghia, Athletic Brewing Co.", neighborhood: "Midtown", imageUrl: "venue-images/rosemarysmid.jpeg" },
      { name: "Hutong NYC", address: "731 Lexington Ave, NY", lat: 40.761812, lng: -73.968178, website: "https://hutong-nyc.com", brand: "Athletic Brewing Co., Pathfinder", neighborhood: "Midtown", imageUrl: "venue-images/hutongmid.jpeg" },
      { name: "The Penrose", address: "1590 2nd Ave, NY", lat: 40.7763, lng: -73.9498, website: "https://penrosebar.com", brand: "Seedlip, Lyre's", neighborhood: "Upper East Side", imageUrl: "venue-images/penrose.jpeg" },
      { name: "Orsay", address: "1057 Lexington Ave, NY", lat: 40.7731, lng: -73.9599, website: "https://orsayrestaurant.com", brand: "Seedlip", neighborhood: "Upper East Side", imageUrl: "venue-images/orsay.jpeg" },
      { name: "Boqueria", address: "1460 2nd Ave, NY", lat: 40.7728, lng: -73.953, website: "https://boqueriarestaurant.com", brand: "Ritual Zero Proof, Seedlip, Athletic Brewing Co.", neighborhood: "Upper East Side", imageUrl: "venue-images/boqueria.jpeg" },
      { name: "Crave Fishbar", address: "945 2nd Ave, NY", lat: 40.7544, lng: -73.9685, website: "https://cravefishbar.com", brand: "Seedlip", neighborhood: "Midtown" },
      { name: "UVA", address: "1486 2nd Ave, NY", lat: 40.7726, lng: -73.9541, website: "https://uvanyc.com", brand: "Lyre's, Athletic Brewing Co.", neighborhood: "Upper East Side", imageUrl: "venue-images/uva.jpeg" },
      { name: "Sefton", address: "510 E 117th St, NY", lat: 40.7969, lng: -73.9304, website: "https://seftonnyc.com", brand: "Ritual Zero Proof", neighborhood: "Upper East Side", imageUrl: "venue-images/sefton.jpeg" },
      { name: "Hawksmoor NYC", address: "109 E 22nd St, NY", lat: 40.7394, lng: -73.9861, website: "https://thehawksmoor.com/us/?pl=null&utm_source=google&utm_medium=organic&utm_campaign=gbp", brand: "Seedlip, Good Time Brewing, Pathfinder", neighborhood: "Gramercy", imageUrl: "venue-images/hawksmoor.jpeg" },
      { name: "Monkey Bar", address: "60 E 54th St, NY", lat: 40.7598, lng: -73.9732, website: "https://www.nycmonkeybar.com", brand: "Ritual Zero Proof, St. Agrestis, Athletic Brewing Co.", neighborhood: "Midtown", imageUrl: "venue-images/monkeybar.jpeg" },
      { name: "Gramercy Tavern", address: "42 E 20th St, NY", lat: 40.7386, lng: -73.9882, website: "https://www.gramercytavern.com", brand: "Lyre's, St. Agrestis", neighborhood: "Gramercy", imageUrl: "venue-images/gramercytavern.jpeg" },
      { name: "The Junction", address: "329 Lexington Ave, NY", lat: 40.747, lng: -73.976, website: "https://www.thejunctionnyc.com", brand: "Lyre's, Seedlip, Athletic Brewing Co.", neighborhood: "Midtown", imageUrl: "venue-images/junction.jpeg" },
      { name: "Broken Shaker", address: "23 Lexington Ave, NY", lat: 40.7395, lng: -73.9845, website: "https://www.brokenshaker.com", brand: "Seedlip, Ritual Zero Proof", neighborhood: "Midtown", imageUrl: "venue-images/brokenshaker.jpeg" },
      { name: "Wildflower", address: "505 W 23 St A, NY", lat: 40.744, lng: -73.9988, website: "https://www.wildflowernyc.com", brand: "Seedlip, St. Agrestis, Athletic Brewing Co.", neighborhood: "Chelsea", imageUrl: "venue-images/wildflower.jpeg" },
      { name: "The Campbell", address: "15 Vanderbilt Ave, NY", lat: 40.7525, lng: -73.9778, website: "https://www.thecampbellnyc.com", brand: "St. Agrestis, Lyre's", neighborhood: "Midtown", imageUrl: "venue-images/campbell.jpeg" },
      { name: "Jungle Bird", address: "174 8th Ave, NY", lat: 40.7429, lng: -74.0011, website: "https://junglebirdnyc.com", brand: "St. Agrestis, Ritual Zero Proof, Lyre's, Pathfinder", neighborhood: "Chelsea", imageUrl: "venue-images/junglebird.jpeg" },
      { name: "Sempre Oggi", address: "164 W 75th St, NY", lat: 40.7803, lng: -73.9799, website: "https://www.semprenyc.com", brand: "St. Agrestis, Athletic Brewing Co.", neighborhood: "Upper West Side", imageUrl: "venue-images/sempreoggi.jpeg" },
      { name: "The Wolfe", address: "425 Amsterdam Ave, NY", lat: 40.7868, lng: -73.9783, website: "https://www.thewolfenyc.com", brand: "St. Agrestis, Lyre's, Athletic Brewing Co.", neighborhood: "Upper West Side", imageUrl: "venue-images/wolfe.jpeg" },
      { name: "Elea", address: "217 W 85th St, NY", lat: 40.7893, lng: -73.9766, website: "https://eleanyc.com", brand: "Ritual Zero Proof", neighborhood: "Upper West Side", imageUrl: "venue-images/elea.jpeg" },
      { name: "Friend of a Farmer", address: "68 W 71st St, NY", lat: 40.7782, lng: -73.9791, website: "https://www.friendofafarmer.com", brand: "Seedlip, Ghia, Athletic Brewing Co.", neighborhood: "Upper West Side", imageUrl: "venue-images/friendfarmer.jpeg" },
      { name: "Bar Pendry", address: "438 W 33rd St, NY", lat: 40.7536, lng: -73.9934, website: "https://www.pendry.com/manhattan-west/", brand: "Lyre's", neighborhood: "Midtown", imageUrl: "venue-images/barpendry.jpeg" },
      { name: "The Portrait Bar", address: "1 W 28th St, NY", lat: 40.745, lng: -73.9886, website: "https://www.theportraitbar.com", brand: "Apl√≥s, Seedlip, Ritual Zero Proof, Athletic Brewing Co.", neighborhood: "Midtown", imageUrl: "venue-images/portraitbar.jpeg" },
      { name: "Clemente Bar", address: "11 Madison Ave, NY", lat: 40.7417, lng: -73.9872, website: "https://www.clementebar.com", brand: "Seedlip, Athletic Brewing Co.", neighborhood: "Flatiron", imageUrl: "venue-images/clemente.jpeg" },
      { name: "Del Frisco's Grille", address: "50 Rockefeller Plaza, NY", lat: 40.759, lng: -73.9799, website: "https://www.delfriscosgrille.com", brand: "Apl√≥s, Ritual Zero Proof", neighborhood: "Midtown", imageUrl: "venue-images/delfriscoe.jpeg" },
      { name: "Cosme", address: "35 E 21st St, NY", lat: 40.7396, lng: -73.9884, website: "https://cosmenyc.com", brand: "Seedlip", neighborhood: "Flatiron", imageUrl: "venue-images/cosme.jpeg" },
      { name: "Bar Calico", address: "23 Lexington Ave, NY", lat: 40.7415, lng: -73.9874, website: "https://barcaliconyc.com", brand: "Ritual Zero Proof, Seedlip", neighborhood: "Flatiron", imageUrl: "venue-images/barcalico.jpeg" },
      { name: "Lobby Bar at The Edition", address: "5 Madison Ave, NY", lat: 40.742, lng: -73.987, website: "https://www.editionhotels.com/new-york/restaurants-and-bars/lobby-bar/", brand: "Lyre's", neighborhood: "Flatiron", imageUrl: "venue-images/lobbybaredition.jpeg" },
      { name: "L'Americana", address: "51 Irving Place, NY", lat: 40.7375, lng: -73.9854, website: "https://www.lamericana-nyc.com", brand: "Seedlip, Good Time Brewing", neighborhood: "Gramercy", imageUrl: "venue-images/lamericana.jpeg" },
      { name: "Handcraft Kitchen & Cocktails", address: "367 3rd Ave, NY", lat: 40.7429, lng: -73.9796, website: "https://www.handcraftnyc.com", brand: "Seedlip, Lyre's, Ritual Zero Proof", neighborhood: "Midtown", imageUrl: "venue-images/handcraft.jpeg" },
      { name: "Decoy", address: "529 Hudson St, NY", lat: 40.7348, lng: -74.0061, website: "https://www.decoynyc.com", brand: "Seedlip", neighborhood: "West Village", imageUrl: "venue-images/decoy.jpeg" },
      { name: "Dante West Village", address: "551 Hudson St, NY", lat: 40.7353, lng: -74.0054, website: "https://www.dante-nyc.com/wv/", brand: "Seedlip, Lyre's", neighborhood: "West Village", imageUrl: "venue-images/dante.jpeg" },
      { name: "Hudson Hound", address: "575 Hudson St, NY", lat: 40.7361, lng: -74.0063, website: "https://hudsonhoundnyc.com", brand: "Lyre's", neighborhood: "West Village", imageUrl: "venue-images/hudsonhound.jpeg" },
      { name: "Wilfie & Nell", address: "228 W 4th St, NY", lat: 40.7338, lng: -74.0028, website: "https://www.wilfieandnell.com", brand: "Seedlip, Athletic Brewing Co., Good Time Brewing", neighborhood: "West Village", imageUrl: "venue-images/wilfienell.jpeg" },
      { name: "Fiddlesticks Pub", address: "56 Greenwich Ave, NY", lat: 40.7359, lng: -74.0021, website: "https://www.fiddlesticksnyc.net", brand: "St. Agrestis, Seedlip", neighborhood: "West Village", imageUrl: "venue-images/fiddlesticks.jpeg" },
      { name: "Death & Co", address: "433 E 6th St, NY", lat: 40.7275, lng: -73.9846, website: "https://www.deathandcompany.com", brand: "Pathfinder, Seedlip, Ritual Zero Proof, Lyre's", neighborhood: "East Village", imageUrl: "venue-images/deathco.jpeg" },
      { name: "Pineapple Club", address: "509 E 6th St, NY", lat: 40.7268, lng: -73.9789, website: "http://pineappleclub.com", brand: "St. Agrestis", neighborhood: "East Village", imageUrl: "venue-images/pineappleclub.jpeg" },
      { name: "Hard to Explain", address: "224 E 10th St, NY", lat: 40.7299, lng: -73.9831, website: "https://www.hardtoexplain.co", brand: "Good Time Brewing", neighborhood: "East Village", imageUrl: "venue-images/hardtoexplain.jpeg" },
      { name: "The Cabinet Mezcal Bar", address: "649 E 9th St, NY", lat: 40.72546, lng: -73.97816, website: "https://www.thecabinetnyc.com", brand: "Athletic Brewing Co.", neighborhood: "East Village", imageUrl: "venue-images/thecabinet.jpeg" },
      { name: "Superbueno", address: "13 1st Ave, NY", lat: 40.7273, lng: -73.9896, website: "https://www.superbuenonyc.com", brand: "Pathfinder, Curious Elixirs, Apl√≥s, Good Time Brewing", neighborhood: "East Village", imageUrl: "venue-images/superbueno.jpeg" },
      { name: "Donna", address: "7 Cornelia St, NY", lat: 40.7316, lng: -74.0035, website: "https://www.donnanyc.com", brand: "Ritual Zero Proof, St. Agrestis, Pathfinder", neighborhood: "West Village", imageUrl: "venue-images/donna.jpeg" },
      { name: "Entwine Cocktail Bar", address: "765 Washington St, NY", lat: 40.7342, lng: -74.0062, website: "https://www.entwinenyc.com", brand: "Athletic Brewing Co., St. Agrestis", neighborhood: "West Village", imageUrl: "venue-images/entwine.jpeg" },
      { name: "One White Street", address: "1 White St, NY", lat: 40.7167, lng: -74.0081, website: "https://www.onewhitestreetnyc.com", brand: "Seedlip, Pathfinder, St. Agrestis, Athletic Brewing Co.", neighborhood: "Tribeca", imageUrl: "venue-images/onewhite.jpeg" },
      { name: "Macao Trading Company", address: "311 Church St, NY", lat: 40.7178, lng: -74.0092, website: "https://www.macaonyc.com", brand: "Pathfinder, Athletic Brewing Co.", neighborhood: "Tribeca", imageUrl: "venue-images/macao.jpeg" },
      { name: "Saint Tuesday", address: "24 Cortlandt Alley, NY", lat: 40.7174, lng: -74.0060, website: "https://www.sainttuesdaynyc.com", brand: "Lyre's, Pathfinder, Ghia", neighborhood: "Tribeca", imageUrl: "venue-images/sanittuesday.jpeg" },
      { name: "North Bar", address: "458 Greenwich St, NY", lat: 40.7204, lng: -74.0097, website: "http://northbartribeca.com", brand: "Athletic Brewing Co.", neighborhood: "Tribeca", imageUrl: "venue-images/northbar.jpeg" },
      { name: "Bridges", address: "9 Chatham Sq, NY", lat: 40.7135, lng: -73.9981, website: "https://www.bridges-nyc.com", brand: "Lyre's, Pathfinder, Good Time Brewing", neighborhood: "Tribeca", imageUrl: "venue-images/bridges.jpeg" },
      { name: "Trinity Place", address: "115 Broadway, NY", lat: 40.7070, lng: -74.0112, website: "https://www.trinityplacenyc.com", brand: "Lyre's, Athletic Brewing Co.", neighborhood: "FiDi", imageUrl: "venue-images/trinity.jpeg" },
      { name: "Bar Belly", address: "14 Orchard St, NY", lat: 40.7168, lng: -73.9910, website: "https://www.barbellynyc.com", brand: "Pathfinder, Seedlip, Good Time Brewing", neighborhood: "East Village", imageUrl: "venue-images/barbelly.jpeg" },
      { name: "Lucky Tiger", address: "66 Pearl St, NY", lat: 40.7075, lng: -74.0026, website: "https://www.luckytigernyc.com", brand: "St. Agrestis", neighborhood: "FiDi", imageUrl: "venue-images/luckytiger.jpeg" },
      { name: "The Bedford", address: "55 Stone St, NY", lat: 40.7263, lng: -73.9819, website: "https://www.thebedford.nyc", brand: "Seedlip", neighborhood: "FiDi", imageUrl: "venue-images/bedford.jpeg" },
      { name: "Tradwell Park", address: "301 S End Ave, NY", lat: 40.7160, lng: -74.0105, website: "https://www.treadwellpark.com/location/downtown/", brand: "Lyre's, Athletic Brewing Co.", neighborhood: "Tribeca", imageUrl: "venue-images/tradewellpark.jpeg" },
      { name: "Bar Tizio", address: "107 Horatio St, NY", lat: 40.7358, lng: -74.0050, website: "https://www.bartizio.com", brand: "St. Agrestis", neighborhood: "West Village", imageUrl: "venue-images/bartizio.jpeg" },
      { name: "Grove Street Social", address: "39 Grove St, NY", lat: 40.7337, lng: -74.0021, website: "https://www.grovestreetsocial.com", brand: "Guinness, Heineken, Curious Elixirs", neighborhood: "West Village" },
      { name: "Art Bar", address: "52 8th Ave, NY", lat: 40.7390, lng: -74.0039, website: "https://www.artbarnyc.com", brand: "Ghia, Guinness, Athletic Brewing Co.", neighborhood: "West Village" }, 
      { name: "Marlow East", address: "1015 Lexington Ave, NY", lat: 40.7716, lng: -73.9607, website: "https://www.marloweast.com", brand: "Ghia, Pathfinder", neighborhood: "Upper East Side" },
      { name: "Cafe Fiorello", address: "1900 Broadway, NY", lat: 40.7713, lng: -73.9819, website: "https://www.cafefiorello.com", brand: "Lyre's, St. Agrestis, Athletic Brewing Co.", neighborhood: "Upper West Side" },
      { name: "Paris Bar", address: "120 W 57th St, NY", lat: 40.7640, lng: -73.9776, website: "https://www.parisbar.com", brand: "Lyre's, Ghia, Athletic Brewing Co.", neighborhood: "Midtown" },
      { name: "Tartinery", address: "2090 Broadway, NY", lat: 40.7782, lng: -73.9813, website: "https://www.tartinery.com", brand: "Ghia", neighborhood: "Upper West Side" },
      { name: "P.J. Clarke's", address: "4 Columbus Cir, NY", lat: 40.7680, lng: -73.9836, website: "https://www.pjclarkes.com", brand: "Athletic Brewing Co., Heineken, Ghia, Lyre's", neighborhood: "Upper West Side" },
      { name: "The Empire Rooftop", address: "44 W 63rd St, NY", lat: 40.7719, lng: -73.9832, website: "https://www.theempirerooftop.com", brand: "Run Wild, Corona, Lyre's, St. Agrestis, Ritual Zero Proof", neighborhood: "Upper West Side" },
      { name: "Allure Bar", address: "80 Riverside Blvd, NY", lat: 40.7807, lng: -73.9886, website: "https://www.allurebar.com", brand: "Seedlip, Run Wild", neighborhood: "Upper West Side" },
      { name: "Park Lane", address: "36 Central Park S, NY", lat: 40.7666, lng: -73.9777, website: "https://www.parklanenewyork.com", brand: "Curious Elixirs", neighborhood: "Midtown" },
      { name: "Cotta", address: "513 Columbus Ave, NY", lat: 40.7871, lng: -73.9725, website: "https://www.cottanyc.com", brand: "Curious Elixirs, St. Agrestis, Good Time Brewing", neighborhood: "Upper West Side" },
      { name: "The Spaniard", address: "190 W 4th St, NY", lat: 40.7346, lng: -74.0007, website: "https://www.thespaniardnyc.com", brand: "Curious Elixirs, St. Agrestis, Seedlip, Good Time Brewing", neighborhood: "West Village" },
      { name: "Peck Slip Social", address: "36 Peck Slip, NY", lat: 40.7079, lng: -74.0016, website: "https://www.peckslipsocial.com", brand: "Curious Elixirs, Guinness, St. Agrestis", neighborhood: "FiDi" },
      { name: "Shy Shy", address: "520 W 27th St, NY", lat: 40.7502, lng: -74.0049, website: "https://www.shyshynyc.com", brand: "Ritual Zero Proof, Pentire, Giffard", neighborhood: "Chelsea" },
      { name: "Markette", address: "135 W 24th St, NY", lat: 40.7447, lng: -73.9944, website: "https://www.markettenyc.com", brand: "St. Agrestis", neighborhood: "Chelsea" },
      { name: "Hello Hello Bar", address: "138 W 26th St, NY", lat: 40.7456, lng: -73.9936, website: "https://www.hellohellonyc.com", brand: "Pathfinder, Apl√≥s, Good Time Brewing", neighborhood: "Chelsea" },
      { name: "Little Rebel", address: "129 Orchard St, NY", lat: 40.7201, lng: -73.9889, website: "https://www.littlerebelnyc.com", brand: "Lyre's, Seedlip", neighborhood: "East Village" },
      { name: "The Cabinet", address: "649 E 9th St, NY", lat: 40.7264, lng: -73.9794, website: "https://www.thecabinetnyc.com", brand: "Athletic Brewing Co.", neighborhood: "East Village" },
      { name: "The Dutch", address: "131 Sullivan St, NY", lat: 40.7259, lng: -74.0013, website: "https://www.thedutchnyc.com", brand: "Apl√≥s, Pentire, Ritual Zero Proof, Pathfinder", neighborhood: "SoHo" },
      { name: "Raon", address: "119 E 54th St, NY", lat: 40.7596, lng: -73.9692, website: "https://www.raonnyc.com", brand: "Seedlip, Pentire, Apl√≥s", neighborhood: "Upper East Side" },
      { name: "Nothing Really Matters", address: "30 W 48th St, NY", lat: 40.7571, lng: -73.9815, website: "https://www.nothingreallymatters.bar", brand: "Lager, Apl√≥s", neighborhood: "Midtown" },
      { name: "Dutch Freds", address: "307 W 47th St, NY", lat: 40.7597, lng: -73.9883, website: "https://www.dutchfreds.com", brand: "Good Time Brewing, Stella Artois, Guinness, Apl√≥s", neighborhood: "Midtown" },
      { name: "Cuerno", address: "52 W 54th St, NY", lat: 40.7613, lng: -73.9785, website: "https://www.cuernonyc.com", brand: "Ritual Zero Proof, Corona", neighborhood: "Midtown" },
      { name: "Felice on Hudson", address: "15 W 3rd St, NY", lat: 40.7327, lng: -74.0030, website: "https://www.felicerestaurants.com", brand: "Ghia, Peroni, Lyre's", neighborhood: "West Village" },
      { name: "The Park Gate", address: "91 Christopher St, NY", lat: 40.7338, lng: -74.0057, website: "https://www.theparkgatenyc.com", brand: "Guinness, Good Time Brewing, Athletic Brewing Co., Lyre's", neighborhood: "West Village" },
      { name: "American Bar", address: "33 Greenwich Ave, NY", lat: 40.7352, lng: -74.0026, website: "https://www.americanbarnyc.com", brand: "Pentire, Kin Euphorics, Seedlip", neighborhood: "West Village" },
      { name: "Travelers Poets & Friends", address: "442 Hudson St, NY", lat: 40.7320, lng: -74.0067, website: "https://www.travelersnyc.com", brand: "Pathfinder, St. Agrestis", neighborhood: "West Village" },
      { name: "53", address: "53 W 53rd St, NY", lat: 40.7610, lng: -73.9776, website: "https://www.53-nyc.com", brand: "Lyre's, Pentire, Pathfinder, St. Agrestis", neighborhood: "Midtown" },
      { name: "Naro", address: "10 Rockefeller Plaza, NY", lat: 40.7587, lng: -73.9787, website: "https://www.naronyc.com", brand: "Seedlip, Apl√≥s", neighborhood: "Midtown" },
      { name: "King", address: "18 King St, NY", lat: 40.7276, lng: -74.0036, website: "https://www.kingrestaurant.nyc", brand: "Ghia, Lyre's, Athletic Brewing Co.",neighborhood: "SoHo" },
      { name: "Carne Mare", address: "89 South St, NY", lat: 40.7062, lng: -74.0034, website: "https://www.carnemare.com", brand: "Athletic Brewing Co., Pentire, Lyre's", neighborhood: "FiDi" },

    ];

    /* =========================
       B) MAP INIT
       ========================= */
    const map = L.map("map", {
      zoomControl: true,
      scrollWheelZoom: true,
    }).setView([40.77, -73.97], 12.6);

    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      {
        maxZoom: 20,
        subdomains: "abcd",
        attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
      }
    ).addTo(map);


    const manhattanBounds = L.latLngBounds(
      [40.5, -74.3], // SW
      [40.98, -73.6] // NE
    );

    map.fitBounds(manhattanBounds);
    map.panBy([0, 120]); // shift pins up visually

    map.setMaxBounds(manhattanBounds);
    map.options.maxBoundsViscosity = 0.1;
    map.setMinZoom(11.5);

    let markersLayer = L.layerGroup().addTo(map);

    /* =========================
       C) ICONS
       ========================= */
    function makePinIconSVG(hex = "#202329", size = [28, 38]) {
      const [w, h] = size;
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 28 38">
          <path fill="${hex}" d="M14 0C6.82 0 1 5.82 1 13c0 9.75 11.4 23.4 12.01 24.13a1.25 1.25 0 0 0 1.98 0C15.6 36.4 27 22.75 27 13 27 5.82 21.18 0 14 0z"/>
          <circle cx="14" cy="13" r="5.2" fill="#fff"/>
        </svg>`;
    }

    function makeIcon(size = [28, 38], color = "#202329") {
      return L.icon({
        iconUrl:
          "data:image/svg+xml;utf8," +
          encodeURIComponent(makePinIconSVG(color, size)),
        iconSize: size,
        iconAnchor: [Math.floor(size[0] / 2), size[1]],
        popupAnchor: [0, -Math.floor(size[1] * 0.84)],
      });
    }

    let currentIcon = makeIcon([28, 38], "#202329");

    L.Marker.prototype.options.icon = currentIcon;

    const __origMarkerFactory = L.marker;
    L.marker = function (latlng, options) {
      const opts = options || {};
      if (!opts.icon) opts.icon = currentIcon;
      return __origMarkerFactory.call(this, latlng, opts);
    };

    const mobileQuery = window.matchMedia("(max-width: 767px)");
    function applyIconForViewport() {
      const isMobile = mobileQuery.matches;
      const size = isMobile ? [18, 26] : [28, 38];
      currentIcon = makeIcon(size, "#202329");
      L.Marker.prototype.options.icon = currentIcon;
      if (markersLayer && markersLayer.eachLayer) {
        markersLayer.eachLayer((layer) => {
          if (layer && typeof layer.setIcon === "function")
            layer.setIcon(currentIcon);
        });
      }
    }
    applyIconForViewport();
    mobileQuery.addEventListener("change", applyIconForViewport);

    /* =========================
       D) UI HELPERS
       ========================= */
    function closeAllMenus() {
      document
        .querySelectorAll(".dropdown")
        .forEach((dd) => dd.classList.remove("open"));
      document
        .querySelectorAll(".dropdown > button")
        .forEach((btn) => btn.setAttribute("aria-expanded", "false"));
    }

    function openMarkerAt(lat, lng) {
      let found = null;
      markersLayer.eachLayer((layer) => {
        const p = layer.getLatLng();
        if (Math.abs(p.lat - lat) < 1e-6 && Math.abs(p.lng - lng) < 1e-6) {
          found = layer;
        }
      });
      if (found) {
        found.openPopup();
      }
    }

    /* =========================
       E) RENDERERS
       ========================= */
    function renderMarkers(data) {
  markersLayer.clearLayers();
  const bounds = L.latLngBounds([]);

  data.forEach((loc) => {
    const m = L.marker([loc.lat, loc.lng]).addTo(markersLayer);

    const imgHtml = loc.imageUrl
      ? `<img class="ss-popup-img" src="${loc.imageUrl}" alt="${loc.name || ""}" loading="lazy"
             onerror="this.style.display='none'">`
      : "";

    m.bindPopup(
  `
  <div class="ss-popup ss-popup--simple">
    ${imgHtml}

    <div class="ss-popup-title">${loc.name || ""}</div>
    <div class="ss-popup-meta">${loc.address || ""}</div>

    <div class="ss-popup-tags">
      ${loc.brand ? loc.brand : ""}
      ${loc.neighborhood ? ` ‚Ä¢ ${loc.neighborhood}` : ""}
    </div>

    <div class="ss-popup-links">
      ${loc.website ? `<a class="ss-popup-link" href="${loc.website}" target="_blank" rel="noopener">Website</a>` : ""}
      <a class="ss-popup-link" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
        (loc.name || "") + " " + (loc.address || "")
      )}" target="_blank" rel="noopener">Directions</a>
    </div>
  </div>
  `,
  { minWidth: 220, maxWidth: 280, autoPanPadding: [18, 18], closeButton: true }
);

    bounds.extend([loc.lat, loc.lng]);
  });

  return { count: data.length, bounds: data.length ? bounds : null };
}

    function renderList(data) {
      const results = document.getElementById("results");
      const resultsCount = document.getElementById("results-count");
      
      results.innerHTML = "";

      // ‚úÖ update results count
  if (resultsCount) {
    resultsCount.textContent =
      data.length === 0
        ? "No places found"
        : `${data.length} place${data.length === 1 ? "" : "s"}`;
  }
      
      data.forEach((loc) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
  <div class="card-top">
    <span class="card-name" onclick="map.setView([${loc.lat}, ${loc.lng}], 16); openMarkerAt(${loc.lat}, ${loc.lng});">${loc.name}</span>
    <button class="fav-btn" data-id="${(loc.name + "|" + loc.address).toLowerCase()}" aria-label="Favorite">‚òÖ</button>
  </div>

  <div class="meta">${loc.address}</div>
  <a href="${loc.website}" target="_blank" rel="noopener">Website</a>
  <div class="meta">Brand: ${loc.brand || ""}</div>
  <div class="meta">Neighborhood: ${loc.neighborhood || ""}</div>
`;

        results.appendChild(card);
      });
    }

    document.addEventListener("click", (e) => {
  const btn = e.target.closest(".fav-btn");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const venueId = btn.dataset.id;

  // Find matching venue (same id logic used in renderList)
  const v = locations.find(x => String((x.name + "|" + x.address).toLowerCase()) === String(venueId));
  if (!v) return;

  // Toggle UI
  btn.classList.toggle("is-fav");

  // Send to iOS app
  window.webkit?.messageHandlers?.favorites?.postMessage({
    action: "toggle",
    venue: {
      venueId: String(venueId),
      name: v.name || "",
      address: v.address || "",
      website: v.website || "",
      neighborhood: v.neighborhood || "",
      brands: v.brand || ""
    }
  });
});

    /* =========================
       ACTIVE FILTER CHIPS
       ========================= */
    function updateActiveFilters(selectedBrands, selectedNeighborhoods) {
      const container = document.getElementById("active-filters");
      if (!container) return;

      container.innerHTML = "";

      const hasAny =
        selectedBrands.length || selectedNeighborhoods.length;
      container.style.display = hasAny ? "flex" : "none";
      if (!hasAny) return;

      function makePill(type, value) {
        const pill = document.createElement("span");
        pill.className = "filter-pill";

        const x = document.createElement("span");
        x.className = "filter-pill-x";
        x.textContent = "√ó";

        const label = document.createElement("span");
        label.textContent = value;

        x.addEventListener("click", () => {
          clearSingleFilter(type, value);
        });

        pill.appendChild(x);
        pill.appendChild(label);
        container.appendChild(pill);
      }

      selectedNeighborhoods.forEach((n) => makePill("neighborhood", n));
      selectedBrands.forEach((b) => makePill("brand", b));
    }

    function clearSingleFilter(type, value) {
      if (type === "brand") {
        document
          .querySelectorAll('input[id^="brand-"]')
          .forEach((cb) => {
            if (cb.value === value) cb.checked = false;
          });
      } else if (type === "neighborhood") {
        document.querySelectorAll('input[id^="n-"]').forEach((cb) => {
          if (cb.value === value) cb.checked = false;
        });
      }
      applyFilters();
    }

    /* =========================
       F) FILTER LOGIC
       ========================= */
    function getSelectedValues(prefix) {
      return Array.from(
        document.querySelectorAll(`input[id^="${prefix}-"]:checked`)
      ).map((cb) => cb.value);
    }

    function applyFilters() {
      closeAllMenus();

      const selectedBrands = getSelectedValues("brand");
      const selectedNeighborhoods = getSelectedValues("n");

      const q = (document.getElementById("searchTopInput")?.value || "").trim();
      const hasSearch = q.length > 0;

      const filtered = locations.filter((loc) => {
        const brandOK = selectedBrands.length
          ? selectedBrands.some(
              (b) =>
                loc.brand &&
                loc.brand.toLowerCase().includes(b.toLowerCase())
            )
          : true;

        const hoodOK = selectedNeighborhoods.length
          ? selectedNeighborhoods.includes(loc.neighborhood)
          : true;

        const searchOK = matchesSearch(loc, q); // ‚úÖ ADD THIS

        return brandOK && hoodOK && searchOK;   // ‚úÖ CHANGE THIS
      });


      renderList(filtered);
      const { count, bounds } = renderMarkers(filtered);
      updateActiveFilters(selectedBrands, selectedNeighborhoods);

      if (count > 0 && bounds && !hasSearch) {
        map.fitBounds(bounds, { padding: [30, 30], maxZoom: 16 });
      }

      window.filteredBounds = bounds;

      // ‚úÖ Disabled: causes the bottom panel to jump when the keyboard opens on iOS
      // if (window.matchMedia("(max-width: 768px)").matches) {
      //   const panelEl = document.getElementById("bottom-panel");
      //   if (panelEl) {
      //     setTimeout(
      //       () =>
      //         panelEl.scrollIntoView({
      //           behavior: "smooth",
      //           block: "start",
      //         }),
      //       60
      //     );
      //   }
      // }


      setTimeout(() => map.invalidateSize(true), 120);
    }

    /* =========================
       G) EVENT WIRING
       ========================= */
    document.addEventListener("click", (e) => {
      const dd = e.target.closest(".dropdown");
      const btn = e.target.closest(".dropdown > button");
      if (btn) {
        const parent = btn.parentElement;
        const willOpen = !parent.classList.contains("open");
        closeAllMenus();
        if (willOpen) {
          parent.classList.add("open");
          btn.setAttribute("aria-expanded", "true");
        }
      } else if (!dd && !e.target.closest("#searchTopRow") && !e.target.closest("#searchToggle")) {
        closeAllMenus();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeAllMenus();
    });

    document.querySelectorAll(".dropdown > button").forEach((btn) => {
      btn.setAttribute("aria-haspopup", "true");
      const dd = btn.parentElement;
      const menu = dd.querySelector(".menu");
      if (dd && menu) {
        const id = dd.id
          ? dd.id + "-menu"
          : "menu-" + Math.random().toString(36).slice(2);
        menu.id = id;
        btn.setAttribute("aria-controls", id);
      }
    });

    document.getElementById("goBtn").addEventListener("click", applyFilters);

// ==============================
// TOP SEARCH TOGGLE
// ==============================
(() => {
  const toggleBtn = document.getElementById("searchToggle");
  const row = document.getElementById("searchTopRow");
  const input = document.getElementById("searchTopInput");

  if (!toggleBtn || !row) return;

  function openRow() {
    row.classList.add("is-open");
    toggleBtn.setAttribute("aria-expanded", "true");
    setTimeout(() => input?.focus(), 50);
  }

  function closeRow() {
    row.classList.remove("is-open");
    toggleBtn.setAttribute("aria-expanded", "false");
    input?.blur();
  }

  toggleBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    row.classList.contains("is-open") ? closeRow() : openRow();
  });

  document.addEventListener("click", (e) => {
    if (!row.classList.contains("is-open")) return;
    if (e.target.closest("#searchTopRow") || e.target.closest("#searchToggle")) return;
    closeRow();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeRow();
  });
})();


    // ==============================
// TOP SEARCH (after Go button)
// ==============================

function matchesSearch(loc, q) {
  if (!q) return true;
  const hay = [
    loc.name,
    loc.address,
    loc.brand,
    loc.neighborhood
  ].filter(Boolean).join(" ").toLowerCase();
  return hay.includes(q.toLowerCase());
}

const searchInput = document.getElementById("searchTopInput");
const searchClear = document.getElementById("searchTopClear");

// Enter key = apply filters
searchInput?.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    applyFilters();
    document.getElementById("searchTopRow")?.classList.remove("is-open");
    document.getElementById("searchToggle")?.setAttribute("aria-expanded","false");
    searchInput.blur();
  }
});

// Clear (√ó)
searchClear?.addEventListener("click", () => {
  if (searchInput) searchInput.value = "";
  applyFilters();
});

  
// =========================
// Bottom panel expand / collapse toggle
// =========================
(function () {
  const panel = document.getElementById("bottom-panel");
  const toggle = document.getElementById("panel-toggle");
  const label = toggle?.querySelector(".label");

  if (!panel || !toggle) return;

  function syncLabel() {
    const expanded = panel.classList.contains("expanded");
    toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
    if (label) label.textContent = expanded ? "Hide" : "Show";
  }

  // Toggle on tap
  toggle.addEventListener("click", (e) => {
    e.stopPropagation(); // important: prevents scrollIntoView interference
    panel.classList.toggle("expanded");
    syncLabel();
  });

  // Optional: auto-expand on mobile when results update
  if (window.matchMedia("(max-width: 768px)").matches) {
    panel.classList.add("expanded");
  }

  syncLabel();
})();

    /* =========================
       I) INITIALIZE
       ========================= */
    renderList(locations);
    const initial = renderMarkers(locations);
    if (initial.bounds) map.fitBounds(initial.bounds, { padding: [30, 30] });

    setTimeout(() => map.invalidateSize(), 150);
  
    /* =========================
   Bottom Tab Bar Logic
   ========================= */
(() => {
  const nav = document.getElementById('bottom-nav');
  if (!nav) return;

  const btns = nav.querySelectorAll('.tab-btn');
  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      btns.forEach(b => b.classList.remove('is-active'));
      btn.classList.add('is-active');
    });
  });
})();

// ================================
// Swift ‚Üí JS sync (keep stars filled)
// ================================
window.SipSober = window.SipSober || {};

window.SipSober.setFavorites = function (payload) {
  const ids = new Set((payload && payload.ids) || []);

  document.querySelectorAll(".fav-btn[data-id]").forEach(btn => {
    const id = btn.dataset.id;
    btn.classList.toggle("is-fav", ids.has(id));
  });
};

  </script>

  <!-- ===== Sip Sober: one-time onboarding banner JS ===== -->
  <script>
  (function () {
    const KEY = "ss_seen_map_onboarding_v1";

    function showOnboarding() {
      const el = document.getElementById("ss-onboard");
      if (!el) return;

      el.hidden = false;
      requestAnimationFrame(() => el.classList.add("is-visible"));

      const okBtn = document.getElementById("ss-onboard-ok");

      function dismiss() {
        localStorage.setItem(KEY, "true");
        el.classList.remove("is-visible");
        setTimeout(() => {
          el.hidden = true;
        }, 240);
      }

      okBtn?.addEventListener("click", dismiss);
      
      // Auto-hide after 10s (still marks as seen)
      setTimeout(() => {
        if (!el.hidden) dismiss();
      }, 10000);
    }

  // Show after the page paints
  window.addEventListener("load", () => {
    setTimeout(showOnboarding, 450);
  });

})();
</script>  
</body>
</html>
