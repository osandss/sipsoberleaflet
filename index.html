<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Zero-Proof Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS (latest CDN) -->
  <link rel="stylesheet" 
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous"/>

  <style>
/* =========================
   APPLE MAPS–STYLE LAYOUT
   ========================= */

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #fff;
  color: #111;
}

/* --- Top filters bar --- */
#filters {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 2002;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid #ddd;
}

.dropdown > button {
  background: #f2f2f7;
  border: 1px solid #ccc;
  border-radius: 999px;
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  color: #2f3b69;
}

#goBtn {
  background: #202329;
  color: white;
  border: 0;
  border-radius: 10px;
  padding: 8px 14px;
  font-weight: 600;
  cursor: pointer;
}

/* --- Map fills the screen --- */
#map {
  position: absolute;
  top: 48px; /* leaves space for the filters bar */
  bottom: 0;
  left: 0;
  right: 0;
}

/* --- Dropdown menus (hide/show) --- */
.dropdown {
  position: relative;
}

.dropdown .menu {
  display: none;
  position: absolute;
  top: 120%;
  left: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 8px 12px;
  width: 180px;
  z-index: 3000;
}

.dropdown.open .menu {
  display: block;
}

.dropdown .row {
  display: flex;
  align-items: center;
  gap: 4px;
  margin: 3px 0;
}

/* --- Bottom results panel --- */
#bottom-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 35vh;
  background: #fff;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
  z-index: 2003;
  overflow: hidden;
  transition: height 0.3s ease;
}

#bottom-panel.expanded {
  height: 75vh;
}

#handle {
  width: 40px;
  height: 5px;
  background: #ccc;
  border-radius: 3px;
  margin: 8px auto;
}

#results {
  overflow-y: auto;
  max-height: calc(100% - 20px);
  padding: 10px;
}

.card {
  padding: 10px 8px;
  border-bottom: 1px solid #eee;
  line-height: 1.4;
}

.card-name {
  font-weight: 600;
  cursor: pointer;
  color: #111;
}
.card-name:hover { text-decoration: underline; }

@media (max-width: 767px) {
  #bottom-panel { height: 40vh; }
  #bottom-panel.expanded { height: 80vh; }
}
</style>

</head>
<body>

  <!-- TOP CONTROLS (filters + Go) -->
  <!-- Floating Filters Bar -->
<div id="filters" class="topbar filterbar">
  <div class="dropdown" id="brandDD">
    <button type="button" aria-expanded="false">Brands ▾</button>
    <div class="menu" role="menu">
      <div class="row"><input id="brand-seedlip" type="checkbox" value="Seedlip" /><label for="brand-seedlip">Seedlip</label></div>
      <div class="row"><input id="brand-ritual" type="checkbox" value="Ritual Zero Proof" /><label for="brand-ritual">Ritual Zero Proof</label></div>
      <div class="row"><input id="brand-lyres" type="checkbox" value="Lyre's" /><label for="brand-lyres">Lyre's</label></div>
      <div class="row"><input id="brand-agrestis" type="checkbox" value="St. Agrestis" /><label for="brand-agrestis">St. Agrestis</label></div>
    </div>
  </div>

  <div class="dropdown" id="neighborhoodDD">
    <button type="button" aria-expanded="false">Neighborhoods ▾</button>
    <div class="menu" role="menu">
      <div class="row"><input id="n-ues" type="checkbox" value="Upper East Side" /><label for="n-ues">Upper East Side</label></div>
      <div class="row"><input id="n-midtown" type="checkbox" value="Midtown" /><label for="n-midtown">Midtown</label></div>
      <div class="row"><input id="n-gramercy" type="checkbox" value="Gramercy" /><label for="n-gramercy">Gramercy</label></div>
      <div class="row"><input id="n-chelsea" type="checkbox" value="Chelsea" /><label for="n-chelsea">Chelsea</label></div>
      <div class="row"><input id="n-uws" type="checkbox" value="Upper West Side" /><label for="n-uws">Upper West Side</label></div>
    </div>
  </div>

  <button id="goBtn" type="button">Go</button>
</div>

<!-- Fullscreen Map -->
<div id="map"></div>

<!-- Sliding Bottom Results Panel -->
<div id="bottom-panel">
  <div id="handle"></div>
  <div id="results"></div>
</div>

  <!-- Leaflet JS (latest CDN) -->
  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"></script>

  <script>
    /* =========================
       A) DATA
       ========================= */
    const locations = [
      { name: "Bemelman's Bar", address: "35 E 76th St, NY", lat: 40.7740, lng: -73.9636, website: "https://www.rosewoodhotels.com", brand: "Ritual Zero Proof", neighborhood: "Upper East Side" },
      { name: "Bar Avant (Olly Olly Market)", address: "601 W 26th St, NY", lat: 40.7498, lng: -74.0075, website: "https://ollyollymarket.com", brand: "Seedlip, St. Agrestis", neighborhood: "Chelsea" },
      { name: "Fumo", address: "198 8th Ave, NY", lat: 40.7448, lng: -73.9809, website: "https://fumonyc.com", brand: "Seedlip", neighborhood: "Chelsea" },
      { name: "Miriam", address: "300 Amsterdam Ave, NY", lat: 40.7809, lng: -73.9797, website: "https://miriamrestaurant.com", brand: "Seedlip, Lyre's", neighborhood: "Upper West Side" },
      { name: "Sarabeth's", address: "423 Amsterdam Ave, NY", lat: 40.7860, lng: -73.9770, website: "https://sarabethsrestaurants.com", brand: "Lyre's", neighborhood: "Upper West Side" },
      { name: "Bondurants", address: "303 E 85th St, NY", lat: 40.7770, lng: -73.9518, website: "https://bondurantsnyc.com", brand: "Seedlip, Lyre's", neighborhood: "Upper East Side" },
      { name: "Sfoglia", address: "1402 Lexington Ave, NY", lat: 40.7835, lng: -73.9529, website: "https://sfogliarestaurant.com", brand: "Lyre's, Ritual Zero Proof, St. Agrestis", neighborhood: "Upper East Side" },
      { name: "The Blasket", address: "1085 2nd Ave, NY", lat: 40.7579, lng: -73.9635, website: "https://theblasketnyc.com", brand: "Lyre's, St. Agrestis", neighborhood: "Midtown" },
      { name: "Rosemary's Midtown", address: "825 3rd Ave, NY", lat: 40.7559, lng: -73.9701, website: "https://rosemarysnyc.com", brand: "Lyre's", neighborhood: "Midtown" },
      { name: "Hutong NYC", address: "731 Lexington Ave, NY", lat: 40.761812, lng: -73.968178, website: "https://hutong-nyc.com", brand: "Seedlip, St. Agrestis", neighborhood: "Midtown" },
      { name: "The Penrose", address: "1590 2nd Ave, NY", lat: 40.7763, lng: -73.9498, website: "https://penrosebar.com", brand: "Seedlip, Lyre's", neighborhood: "Upper East Side" },
      { name: "Orsay", address: "1057 Lexington Ave, NY", lat: 40.7731, lng: -73.9599, website: "https://orsayrestaurant.com", brand: "Seedlip", neighborhood: "Upper East Side" },
      { name: "Boqueria", address: "1460 2nd Ave, NY", lat: 40.7728, lng: -73.9530, website: "https://boqueriarestaurant.com", brand: "Ritual Zero Proof, Seedlip", neighborhood: "Upper East Side" },
      { name: "Crave Fishbar", address: "945 2nd Ave, NY", lat: 40.7544, lng: -73.9685, website: "https://cravefishbar.com", brand: "Seedlip", neighborhood: "Midtown" },
      { name: "UVA", address: "1486 2nd Ave, NY", lat: 40.7726, lng: -73.9541, website: "https://uvanyc.com", brand: "Lyre's", neighborhood: "Upper East Side" },
      { name: "Sefton", address: "510 E 117th St, NY", lat: 40.7969, lng: -73.9304, website: "https://seftonnyc.com", brand: "Ritual Zero Proof", neighborhood: "Upper East Side" },
      { name: "Hawksmoor NYC", address: "109 E 22nd St, NY", lat: 40.7394, lng: -73.9861, website: "https://hawksmoor.com/locations/new-york/", brand: "Seedlip", neighborhood: "Gramercy" },
      { name: "Monkey Bar", address: "60 E 54th St, NY", lat: 40.7598, lng: -73.9732, website: "https://www.nycmonkeybar.com", brand: "Ritual Zero Proof, St. Agrestis", neighborhood: "Midtown" },
      { name: "Gramercy Tavern", address: "42 E 20th St, NY", lat: 40.7386, lng: -73.9882, website: "https://www.gramercytavern.com", brand: "Lyre's, St. Agrestis", neighborhood: "Gramercy" },
      { name: "Handcraft Kitchen & Cocktails", address: "367 3rd Avenue, NY", lat: 40.7427, lng: -73.9805, website: "https://www.handcraftnyc.com", brand: "Lyre's, Seedlip, Ritual Zero Proof", neighborhood: "Midtown" },
      { name: "The Junction", address: "329 Lexington Ave, NY", lat: 40.7470, lng: -73.9760, website: "https://www.thejunctionnyc.com", brand: "Lyre's, Seedlip, Ritual Zero Proof", neighborhood: "Midtown" },
      { name: "Broken Shaker", address: "23 Lexington Ave, NY", lat: 40.7395, lng: -73.9845, website: "https://www.brokenshaker.com", brand: "Seedlip, Ritual Zero Proof", neighborhood: "Midtown" },
      { name: "Wildflower", address: "505 W 23 St A, NY", lat: 40.7440, lng: -73.9988, website: "https://www.wildflowernyc.com", brand: "Seedlip, St. Agrestis", neighborhood: "Chelsea" },
      { name: "The Campbell", address: "15 Vanderbilt Ave, NY", lat: 40.7525, lng: -73.9778, website: "https://www.thecampbellnyc.com", brand: "St. Agrestis", neighborhood: "Midtown" },
      { name: "Jungle Bird", address: "174 8th Ave, NY", lat: 40.7429, lng: -74.0011, website: "https://junglebirdnyc.com", brand: "St. Agrestis, Ritual Zero Proof, Seedlip", neighborhood: "Chelsea" },
      { name: "Sempre Oggi", address: "164 W 75th St, NY", lat: 40.7803, lng: -73.9799, website: "https://www.semprenyc.com", brand: "St. Agrestis", neighborhood: "Upper West Side" },
      { name: "The Wolfe", address: "425 Amsterdam Ave, NY", lat: 40.7868, lng: -73.9783, website: "https://www.thewolfenyc.com", brand: "St. Agrestis, Lyre's", neighborhood: "Upper West Side" },
      { name: "Elea", address: "217 W 85th St, NY", lat: 40.7893, lng: -73.9766, website: "https://eleanyc.com", brand: "Ritual Zero Proof", neighborhood: "Upper West Side" },
      { name: "Friend of a Farmer", address: "68 W 71st St, NY", lat: 40.7782, lng: -73.9791, website: "https://www.friendofafarmer.com", brand: "Seedlip", neighborhood: "Upper West Side" },
      { name: "Bar Pendry", address: "438 W 33rd St, NY", lat: 40.7536, lng: -73.9934, website: "https://www.pendry.com/manhattan-west/", brand: "Lyre's", neighborhood: "Midtown" },
      { name: "The Portrait Bar", address: "1 W 28th St, NY", lat: 40.7450, lng: -73.9886, website: "https://www.theportraitbar.com", brand: "Aplós, Seedlip, Ritual Zero Proof", neighborhood: "Midtown" },
      { name: "Clemente Bar", address: "11 Madison Ave, NY", lat: 40.7417, lng: -73.9872, website: "https://www.clementebar.com", brand: "Seedlip", neighborhood: "Midtown" },
      { name: "Del Frisco's Grille", address: "50 Rockefeller Plaza, NY", lat: 40.7590, lng: -73.9799, website: "https://www.delfriscosgrille.com", brand: "Aplós, Ritual Zero Proof", neighborhood: "Midtown" },
    ];

    /* =========================
       B) MAP INIT
       ========================= */
    const map = L.map('map', {
      zoomControl: true,
      scrollWheelZoom: true
    }).setView([40.77, -73.97], 12.6);

    // Tile layer — light/desaturated (Carto Positron)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      subdomains: 'abcd',
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    // Manhattan bounds (approx)
    const manhattanBounds = L.latLngBounds([40.680, -74.047], [40.882, -73.906]);
    map.setMaxBounds(manhattanBounds);
    map.setMinZoom(12.3);
    map.on('drag', () => {
      map.panInsideBounds(manhattanBounds, { animate: true });
    });

    // Keep a layer group for markers
    let markersLayer = L.layerGroup().addTo(map);

    /* =========================
       C) ICONS
       ========================= */
    function makePinIconSVG(hex = '#202329', size = [28, 38]) {
      const [w,h] = size;
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 28 38">
          <path fill="${hex}" d="M14 0C6.82 0 1 5.82 1 13c0 9.75 11.4 23.4 12.01 24.13a1.25 1.25 0 0 0 1.98 0C15.6 36.4 27 22.75 27 13 27 5.82 21.18 0 14 0z"/>
          <circle cx="14" cy="13" r="5.2" fill="#fff"/>
        </svg>`;
    }
    function makeIcon(size = [28,38], color = '#202329'){
      return L.icon({
        iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(makePinIconSVG(color, size)),
        iconSize: size,
        iconAnchor: [Math.floor(size[0]/2), size[1]],
        popupAnchor: [0, -Math.floor(size[1]*0.84)]
      });
    }

    // Default (desktop) icon
    let currentIcon = makeIcon([28,38], '#202329');

    // Make ALL Leaflet markers use this by default
    L.Marker.prototype.options.icon = currentIcon;

    // Force all future markers to use currentIcon
    const __origMarkerFactory = L.marker;
    L.marker = function(latlng, options) {
      const opts = options || {};
      if (!opts.icon) opts.icon = currentIcon;
      return __origMarkerFactory.call(this, latlng, opts);
    };

    // Mobile-only smaller pins
    const mobileQuery = window.matchMedia('(max-width: 767px)');
    function applyIconForViewport() {
      const isMobile = mobileQuery.matches;
      const size = isMobile ? [22, 30] : [28, 38];
      currentIcon = makeIcon(size, '#202329');
      L.Marker.prototype.options.icon = currentIcon;
      // Repaint existing markers
      if (markersLayer && markersLayer.eachLayer) {
        markersLayer.eachLayer((layer) => {
          if (layer && typeof layer.setIcon === 'function') layer.setIcon(currentIcon);
        });
      }
    }
    applyIconForViewport();
    mobileQuery.addEventListener('change', applyIconForViewport);

    /* =========================
       D) UI HELPERS
       ========================= */
    function closeAllMenus() {
      document.querySelectorAll('.dropdown').forEach(dd => dd.classList.remove('open'));
      document.querySelectorAll('.dropdown > button').forEach(btn => btn.setAttribute('aria-expanded', 'false'));
    }

    // Helper to open a marker popup at a given lat/lng
    function openMarkerAt(lat, lng){
      let found = null;
      markersLayer.eachLayer((layer) => {
        const p = layer.getLatLng();
        if (Math.abs(p.lat - lat) < 1e-6 && Math.abs(p.lng - lng) < 1e-6) {
          found = layer;
        }
      });
      if (found){ found.openPopup(); }
    }

    /* =========================
       E) RENDERERS
       ========================= */
    function renderMarkers(data){
      markersLayer.clearLayers();
      const bounds = L.latLngBounds([]);
      data.forEach(loc => {
        const m = L.marker([loc.lat, loc.lng]).addTo(markersLayer);
        m.bindPopup(`
          <div style="min-width:200px">
            <div style="font-weight:600">${loc.name}</div>
            <div class="meta">${loc.address}</div>
            <div><a href="${loc.website}" target="_blank" rel="noopener">Website</a></div>
            <div class="meta">Brand: ${loc.brand||""}</div>
            <div class="meta">Neighborhood: ${loc.neighborhood||""}</div>
          </div>
        `);
        bounds.extend([loc.lat, loc.lng]);
      });
      return { count: data.length, bounds: data.length ? bounds : null };
    }

    function renderList(data){
      const results = document.getElementById('results');
      results.innerHTML = '';
      data.forEach(loc => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <span class="card-name" onclick="map.setView([${loc.lat}, ${loc.lng}], 16); openMarkerAt(${loc.lat}, ${loc.lng});">${loc.name}</span><br/>
          ${loc.address}<br/>
          <a href="${loc.website}" target="_blank" rel="noopener">Website</a><br/>
          <span class="meta">Brand: ${loc.brand||""}</span><br/>
          <span class="meta">Neighborhood: ${loc.neighborhood||""}</span>
        `;
        results.appendChild(card);
      });
    }

    /* =========================
       F) FILTER LOGIC
       ========================= */
    function getSelectedValues(prefix){
      return Array.from(document.querySelectorAll(`input[id^="${prefix}-"]:checked`)).map(cb => cb.value);
    }

    function applyFilters() {
      // Close any open menus
      closeAllMenus();

      const selectedBrands = getSelectedValues('brand');
      const selectedNeighborhoods = getSelectedValues('n');

      const filtered = locations.filter(loc => {
  const brandOK = selectedBrands.length
    ? selectedBrands.some(b => loc.brand && loc.brand.toLowerCase().includes(b.toLowerCase()))
    : true;
  const hoodOK = selectedNeighborhoods.length
    ? selectedNeighborhoods.includes(loc.neighborhood)
    : true;
  return brandOK && hoodOK;
});


      renderList(filtered);
      const { count, bounds } = renderMarkers(filtered);

      if (count > 0 && bounds) {
        // cap zoom so we don't over-zoom and "fight" setMaxBounds
        map.fitBounds(bounds, { padding: [30, 30], maxZoom: 16 });
      }

      // Store bounds for other components if needed
      window.filteredBounds = bounds;

      // On mobile, bring the results list into view under the map
      if (window.matchMedia('(max-width: 768px)').matches) {
        const resEl = document.getElementById('results');
        if (resEl) {
          // ensure map height finalized before scrolling
          setTimeout(() => resEl.scrollIntoView({ behavior: 'smooth', block: 'start' }), 60);
        }
      }

      // Re-measure map after DOM shifts
      setTimeout(() => map.invalidateSize(true), 120);
    }

    /* =========================
       G) EVENT WIRING
       ========================= */
    // Dropdown open/close behavior (click)
    document.addEventListener('click', (e) => {
      const dd = e.target.closest('.dropdown');
      const btn = e.target.closest('.dropdown > button');
      if (btn) {
        const parent = btn.parentElement;
        const willOpen = !parent.classList.contains('open');
        closeAllMenus();
        if (willOpen) {
          parent.classList.add('open');
          btn.setAttribute('aria-expanded', 'true');
        }
      } else if (!dd) {
        closeAllMenus();
      }
    });

    // Close menus on Escape; add light ARIA wiring
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAllMenus();
    });
    // ARIA relationships
    document.querySelectorAll('.dropdown > button').forEach((btn) => {
      btn.setAttribute('aria-haspopup', 'true');
      const dd = btn.parentElement;
      const menu = dd.querySelector('.menu');
      if (dd && menu) {
        const id = dd.id ? dd.id + '-menu' : 'menu-' + Math.random().toString(36).slice(2);
        menu.id = id;
        btn.setAttribute('aria-controls', id);
      }
    });

    document.getElementById('goBtn').addEventListener('click', applyFilters);

    
    /* =========================
       I) INITIALIZE
       ========================= */
    // Initial render: show all
    renderList(locations);
    const initial = renderMarkers(locations);
    if (initial.bounds) map.fitBounds(initial.bounds, { padding:[30,30] });

    // Re-measure map after load to be safe in Wix iframe
    setTimeout(() => map.invalidateSize(), 150);

/* =========================
   J) SLIDE-UP PANEL BEHAVIOR
   ========================= */
const panel = document.getElementById("bottom-panel");
const handle = document.getElementById("handle");
let startY = 0;
let startHeight = 0;
let isDragging = false;

handle.addEventListener("touchstart", (e) => {
  startY = e.touches[0].clientY;
  startHeight = panel.offsetHeight;
  isDragging = true;
});

window.addEventListener("touchmove", (e) => {
  if (!isDragging) return;
  const dy = startY - e.touches[0].clientY;
  const newHeight = Math.min(window.innerHeight * 0.8, Math.max(window.innerHeight * 0.35, startHeight + dy));
  panel.style.height = newHeight + "px";
});

window.addEventListener("touchend", () => {
  if (!isDragging) return;
  isDragging = false;
  const currentHeight = panel.offsetHeight;
  const expanded = currentHeight > window.innerHeight * 0.55;
  panel.classList.toggle("expanded", expanded);
  panel.style.height = "";
});

// Optional: toggle on tap
handle.addEventListener("click", () => {
  panel.classList.toggle("expanded");
});
    
  </script>
</body>
</html>
