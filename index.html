<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Zero-Proof Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS (latest CDN) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous"/>

  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; }
    /* The map must have a height or it renders blank */
    #map { height: calc(100vh - 50px); width: 100%; }

    .dropdown { position: relative; display: inline-block; z-index: 2001; pointer-events: auto; }
    .dropbtn {
      background-color: #f9f9f9; color: #333; padding: 6px 10px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 5px; cursor: pointer;
    }
    .dropdown-content {
      display: none; position: absolute; background-color: white; min-width: 200px;
      border: 1px solid #ccc; z-index: 2020; padding: 8px 8px 10px 8px;
      max-height: 240px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      pointer-events: auto;
    }
    .dropdown-content.open { display: block !important; }
    .dropdown-content label { font-size: 14px; display: block; margin: 6px 0; padding-right: 18px; }
    .dropdown-content input[type="checkbox"] { margin-right: 6px; }
    /* X close button inside dropdowns */
    .close-dd {
      position: sticky; top: 0; float: right; margin-left: auto;
      border: none; background: transparent; font-size: 16px; line-height: 1;
      cursor: pointer; color: #333; padding: 2px 4px;
    }

    #goBtn { padding: 6px 10px; font-size: 14px; border: 1px solid #333; background: #fff; border-radius: 5px; cursor: pointer; }

    #main { display: flex; flex: 1; height: calc(100vh - 50px); }
    #sidebar { width: 42%; max-width: 380px; padding: 8px; overflow-y: auto; border-right: 1px solid #ccc; box-sizing: border-box; position: relative; }
    #toggleSidebar { display: none; position: absolute; top: 10px; left: 10px; z-index: 2030; padding: 6px 10px; font-size: 12px; background: #fff; border: 1px solid #aaa; border-radius: 4px; cursor: pointer; }
    #closeSidebar { position: absolute; top: 6px; right: 6px; font-size: 14px; cursor: pointer; background: #eee; border: none; border-radius: 4px; padding: 2px 6px; }
    #map { flex-grow: 1; height: 100%; }

    .card { border: 1px solid #ddd; border-radius: 6px; padding: 8px; margin-bottom: 8px; font-size: 11.5px; }
    .card a { text-decoration: none; color: #0645AD; }
    .card button { font-size: 11px; margin-top: 4px; padding: 2px 6px; }

    /* Selected filters row */
    #selectedRow {
      display: flex; flex-wrap: wrap; gap: 6px;
      padding: 6px 10px 8px 10px; border-bottom: 1px solid #eee; background: #fff;
      font-size: 12px; align-items: center;
    }
    #selectedRow:empty { display: none; }
    #selectedBrandsRow, #selectedNeighborhoodsRow { display: inline; }
    .sel-title { font-weight: 600; margin-right: 6px; }
    .sel-item {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 2px 6px; border: 1px solid #ccc; border-radius: 12px; background: #f5f5f5;
      margin-right: 6px; margin-bottom: 4px;
    }
    .sel-item .remove { border: none; background: transparent; cursor: pointer; font-size: 12px; line-height: 1; }

    /* Popup styling */
    .leaflet-popup-content .popup { font-size: 12px; line-height: 1.3; }
    .leaflet-popup-content .p-name { margin-bottom: 2px; }
    .leaflet-popup-content .p-addr { color: #333; margin-bottom: 4px; }
    .leaflet-popup-content .p-web a { text-decoration: none; }

    .card-name { color: #000; text-decoration: underline; cursor: pointer; font-weight: 600; }

    /* Keep Leaflet controls under our UI */
    .leaflet-control-container, .leaflet-top, .leaflet-bottom { z-index: 500 !important; }
  </style>
</head>
<body>
  <div id="filters">
    <div class="dropdown">
      <button type="button" class="dropbtn" onclick="toggleDropdown('brandDropdown')">Select Brand ⌄</button>
      <div class="dropdown-content" id="brandDropdown">
        <button class="close-dd" title="Close" onclick="closeDropdown('brandDropdown')">×</button>
        <label><input type="checkbox" value="Lyre's" /> Lyre's</label>
        <label><input type="checkbox" value="Ritual Zero Proof" /> Ritual Zero Proof</label>
        <label><input type="checkbox" value="Seedlip" /> Seedlip</label>
      </div>
    </div>

    <div class="dropdown">
      <button type="button" class="dropbtn" onclick="toggleDropdown('neighborhoodDropdown')">Select Neighborhood ⌄</button>
      <div class="dropdown-content" id="neighborhoodDropdown">
        <button class="close-dd" title="Close" onclick="closeDropdown('neighborhoodDropdown')">×</button>
        <label><input type="checkbox" value="Upper East Side" /> Upper East Side</label>
        <label><input type="checkbox" value="Kips Bay" /> Kips Bay</label>
        <label><input type="checkbox" value="Gramercy" /> Gramercy</label>
        <label><input type="checkbox" value="Upper West Side" /> Upper West Side</label>
        <label><input type="checkbox" value="Chelsea" /> Chelsea</label>
      </div>
    </div>

    <button id="goBtn" type="button" onclick="applyFilters()">Go</button>
  </div>

  <div id="selectedRow">
    <div id="selectedBrandsRow"></div>
    <div id="selectedNeighborhoodsRow"></div>
  </div>

  <div id="main">
    <div id="toggleSidebar">Show Results</div>
    <div id="sidebar">
      <button id="closeSidebar">×</button>
      <div id="results"></div>
    </div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS (latest CDN) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin="anonymous"></script>

  <script>
    /* --- Dropdown helpers --- */
    function toggleDropdown(id) {
      // close other dropdowns
      document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('open'));
      const dd = document.getElementById(id);
      dd.classList.toggle('open');
    }
    function closeDropdown(id) {
      const dd = document.getElementById(id);
      dd.classList.remove('open');
    }
    function getCheckedValues(containerId) {
      return Array.from(document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`)).map(cb=>cb.value.toLowerCase());
    }

    /* --- Map setup --- */
const map = L.map('map', {
  minZoom: 12,  // don’t let users zoom out past Manhattan
  maxZoom: 17   // optional: stop zooming in too far
}).setView([40.76, -73.97], 13);

// Lock the view to Manhattan-ish bounds
map.setMaxBounds([[40.68, -74.05], [40.88, -73.85]]);

   // Single base layer (lighter Carto Positron style)
L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> © <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

    const blackIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/484/484167.png',
      iconSize: [25,25], iconAnchor: [12,25], popupAnchor: [0,-25]
    });

    /* --- Data (same schema as before) --- */
    // NOTE: you have a few malformed rows like {`.7361, ...}
    // We'll guard against bad values so the page still works.
    let allData = [{"name": "The Penrose", "address": "1590 Second Ave", "website": "https://www.penrosebar.com", "brand": "Lyre's, Seedlip", "neighborhood": "Upper East Side", "lat": 40.7755, "lng": -73.9533}, {"name": "Orsay", "address": "1057 Lexington Ave", "website": "https://www.orsayrestaurant.com", "brand": "Seedlip", "neighborhood": "Upper East Side", "lat": 40.7724, "lng": -73.9605}, {"name": "Boqueria", "address": "1460 Second Ave", "website": "https://boqueriarestaurant.com", "brand": "Ritual Zero Proof, Seedlip", "neighborhood": "Upper East Side", "lat": 40.7716, "lng": -73.9554}, {"name": "Bemelmans Bar", "address": "35 East 76th St", "website": "https://www.rosewoodhotels.com/en/the-carlyle-new-york/dining/bemelmans-bar", "brand": "Ritual Zero Proof, Seedlip", "neighborhood": "Upper East Side", "lat": 40.7744, "lng": -73.9632}, {"name": "Crave Fishbar", "address": "945 Second Ave", "website": "https://cravefishbar.com", "brand": "Ritual Zero Proof", "neighborhood": "Upper East Side", "lat": 40.7717, "lng": -73.9556}, {"name": "UVA", "address": "1486 Second Ave", "website": "https://www.uvanyc.com", "brand": "Ritual Zero Proof", "neighborhood": "Upper East Side", "lat": 40.7724, "lng": -73.9556}, {"name": "Sefton", "address": "137 Ludlow St", "website": "https://thesefton.com", "brand": "Ritual Zero Proof", "neighborhood": "Upper East Side", "lat": 40.7691, "lng": -73.9554}, {"name": "Hawksmoor", "address": "109 E 22nd St", "website": "https://www.hawksmoornyc.com", "brand": "Seedlip", "neighborhood": "Gramercy", "lat": 40.739, "lng": -73.985}, {"name": "Gramercy Tavern", "address": "42 E 20th St", "website": "https://www.gramercytavern.com", "brand": "Lyre's", "neighborhood": "Gramercy", "lat": 40.7386, "lng": -73.9882} /* ... keep your other rows here ... */ ];

    // --- Coordinate sanitizer for specific venues ---
    (function fixKnownCoords(){
      const NEED_FIX = new Set([
        "Martiny's",
        "Fumo",
        "Miriam",
        "Sarabeth's",
        "Fumo (Chelsea)",
        "Bar Avant (Olly Olly Market)"
      ]);
      for (const loc of allData) {
        if (!NEED_FIX.has(loc.name)) continue;
        if (typeof loc.lat === 'number' && loc.lat < 0) loc.lat = Math.abs(loc.lat);
        if (typeof loc.lng === 'number') {
          if (loc.lng < -74.05) loc.lng = -74.05;
          if (loc.lng > -73.85) loc.lng = -73.85;
        }
      }
    })();

    let markers = [];

    // Open marker popup by approximate lat/lng
    function openMarkerAt(lat, lng) {
      if (!markers || markers.length === 0) return;
      for (const m of markers) {
        const ll = m.getLatLng();
        if (Math.abs(ll.lat - lat) < 1e-6 && Math.abs(ll.lng - lng) < 1e-6) {
          m.openPopup();
          return;
        }
      }
    }

    function filterAndDisplay() {
      const selectedBrands = getCheckedValues("brandDropdown");
      const selectedNeighborhoods = getCheckedValues("neighborhoodDropdown");
      const results = document.getElementById("results");
      results.innerHTML = "";
      markers.forEach(m => map.removeLayer(m)); markers = [];

      const filtered = allData.filter(loc => {
        const brand = (loc.brand || "").toLowerCase();
        const hood = (loc.neighborhood || "").toLowerCase();

        // Guard against malformed rows
        const validCoords = Number.isFinite(loc.lat) && Number.isFinite(loc.lng);

        const matchesBrand = selectedBrands.length===0 || selectedBrands.some(sel=>brand.includes(sel));
        const matchesHood  = selectedNeighborhoods.length===0 || selectedNeighborhoods.includes(hood);
        return validCoords && matchesBrand && matchesHood;
      }).sort((a,b)=>(a.name||"").localeCompare(b.name||""));

      let bounds = null;

      filtered.forEach(loc => {
        const marker = L.marker([loc.lat, loc.lng], {icon: blackIcon}).addTo(map)
          .bindPopup(`<div class='popup'><div class='p-name'><strong>${loc.name}</strong></div><div class='p-addr'>${loc.address}</div><div class='p-web'><a href='${loc.website}' target='_blank' rel='noopener noreferrer'>Website</a></div></div>`);
        markers.push(marker);

        // keep a small reference on the location object for card->popup
        loc.__marker = marker;

        bounds = bounds ? bounds.extend(marker.getLatLng()) : L.latLngBounds([marker.getLatLng(), marker.getLatLng()]);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<span class="card-name" onclick="map.setView([${loc.lat}, ${loc.lng}], 16); openMarkerAt(${loc.lat}, ${loc.lng});">${loc.name}</span><br/>${loc.address}<br/><a href="${loc.website}" target="_blank">Website</a><br/>Brand: ${loc.brand||""}<br/>Neighborhood: ${loc.neighborhood||""}<br/><button onclick="this.style.color='red'; window.ReactNativeWebView?.postMessage('favorite:' + '${loc.name}')">♡ Favorite</button>`;
        results.appendChild(card);
      });

      return { count: filtered.length, bounds };
    }

    function applyFilters() {
      // Close any open menus
      document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('open'));
      const { count, bounds } = filterAndDisplay();
      if (count > 0 && bounds) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    // Initial render
    filterAndDisplay();

    // --- Selected filters chips (comma-separated with removable ×) ---
    function refreshSelected() {
      const brands = Array.from(document.querySelectorAll('#brandDropdown input[type=checkbox]:checked')).map(cb=>cb.value);
      const hoods  = Array.from(document.querySelectorAll('#neighborhoodDropdown input[type=checkbox]:checked')).map(cb=>cb.value);

      const bRow = document.getElementById('selectedBrandsRow');
      const nRow = document.getElementById('selectedNeighborhoodsRow');
      bRow.innerHTML = '';
      nRow.innerHTML = '';

      if (brands.length > 0) {
        const title = document.createElement('span');
        title.className = 'sel-title';
        title.textContent = 'Brands:';
        bRow.appendChild(title);

        brands.forEach((val, idx) => {
          const chip = document.createElement('span');
          chip.className = 'sel-item';
          chip.innerHTML = `<span>${val}</span><button class="remove" title="Remove" onclick="removeSelection('brandDropdown', '${val.replace("'", "\\'")}')">×</button>`;
          bRow.appendChild(chip);
          if (idx < brands.length - 1) {
            const comma = document.createTextNode(', ');
            bRow.appendChild(comma);
          }
        });
      }

      if (hoods.length > 0) {
        const title = document.createElement('span');
        title.className = 'sel-title';
        title.textContent = 'Neighborhoods:';
        if (brands.length > 0) {
          const spacer = document.createElement('span');
          spacer.style.marginLeft = '10px';
          nRow.appendChild(spacer);
        }
        nRow.appendChild(title);

        hoods.forEach((val, idx) => {
          const chip = document.createElement('span');
          chip.className = 'sel-item';
          chip.innerHTML = `<span>${val}</span><button class="remove" title="Remove" onclick="removeSelection('neighborhoodDropdown', '${val.replace("'", "\\'")}')">×</button>`;
          nRow.appendChild(chip);
          if (idx < hoods.length - 1) {
            const comma = document.createTextNode(', ');
            nRow.appendChild(comma);
          }
        });
      }
    }

    function removeSelection(containerId, value) {
      const boxes = document.querySelectorAll(`#${containerId} input[type=checkbox]`);
      boxes.forEach(cb => {
        if (cb.value === value) cb.checked = false;
      });
      refreshSelected(); // only update list; filtering still waits for Go
    }

    refreshSelected();

    // Auto-close dropdown after any selection, but DO NOT auto-filter until Go
    document.querySelectorAll('#brandDropdown input[type=checkbox], #neighborhoodDropdown input[type=checkbox]').forEach(cb=>cb.addEventListener('change', ()=>{
      document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('open'));
      refreshSelected();
    }));

    // Sidebar toggles
    document.getElementById("closeSidebar").addEventListener("click",()=>{
      document.getElementById("sidebar").style.display="none";
      document.getElementById("toggleSidebar").style.display="block";
      map.invalidateSize();
    });
    document.getElementById("toggleSidebar").addEventListener("click",()=>{
      document.getElementById("sidebar").style.display="block";
      document.getElementById("toggleSidebar").style.display="none";
      map.invalidateSize();
    });

    // Safety: keyboard 'R' reopens results in case the button gets obscured
    document.addEventListener('keydown', (e)=>{
      if (e.key && e.key.toLowerCase() === 'r') {
        const sb  = document.getElementById('sidebar');
        const tog = document.getElementById('toggleSidebar');
        if (sb && tog && sb.style.display === 'none') {
          sb.style.display = 'block';
          tog.style.display = 'none';
          map.invalidateSize();
        }
      }
    });
  </script>
</body>
</html>
