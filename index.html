<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Zero-Proof Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS (latest CDN) -->
  <link rel="stylesheet" 
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous"/>

  <style>
    /* Base */
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#eaeaea;
      --chip:#f6f7fb;
      --chip-text:#2f3b69;
      --accent:#2f3b69;
    }
    html, body { height:100%; }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
    }
    /* Make the page fill the iframe and let layout take the rest */
    body { display: flex; flex-direction: column; }
    
    /* Layout wrappers */
    .topbar.filterbar{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .layout{
      display: flex;              /* Desktop side-by-side by default */
      gap: 12px;
      padding: 0 10px 10px;
      box-sizing: border-box;
      flex: 1 1 auto;             /* fill all remaining height under .topbar */
      min-height: 0;              /* allow children to scroll instead of overflow */
    }

   /* Map & results */
  #map { 
    height: 100%;               /* fill .layout’s height */
    width: 100%;
    border-radius: 10px;
    overflow: hidden;
    flex: 1 1 0;                /* take remaining width */
    min-height: 300px;
  }

  #results{
    width: 360px;               /* desktop side panel width */
    height: 100%;               /* match .layout’s height */
    max-height: none;
    overflow: auto;
    border-left: 1px solid var(--border);
    padding-left: 10px;
    box-sizing: border-box;
    background: var(--bg);
    min-height: 0;
  }

    /* Cards */
    .card{
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      line-height: 1.4;
    }
    .card-name{
      font-weight: 600;
      cursor: pointer;
      color: var(--text);
      text-decoration: none;
    }
    .card-name:hover{ text-decoration: underline; }
    .card .meta{ color: var(--muted); font-size: 12px; }

    /* Dropdowns / filters */
    .dropdown { position: relative; display: inline-block; z-index: 2001; pointer-events: auto; }
    .dropdown > button{
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--chip-text);
      cursor: pointer;
    }
    .dropdown.open > .menu{
      display: block;
    }
    .menu{
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      min-width: 220px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      z-index: 2002; /* above Leaflet controls */
    }
    .menu .row{ display: flex; align-items: center; gap: 8px; padding: 6px 4px; }
    .menu label{ flex: 1; cursor: pointer; }
    .menu input[type="checkbox"]{ transform: translateY(1px); }

    /* Go button */
    #goBtn{
      background: #202329;
      color: white;
      border: 0;
      border-radius: 10px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Ensure filter dropdowns float above Leaflet zoom buttons */
    .dropdown, .filterbar { position: relative; z-index: 2001; }

    /* Leaflet control base z-index (so filters win) */
    .leaflet-top, .leaflet-bottom { z-index: 400; }

    /* ====== Mobile stack: filters → map → list ====== */
    @media (max-width: 767px){
      .layout{ 
        display: block;           /* stack vertically */
        padding: 0;
      }
      /* Keep the filters bar visible at the top on mobile */
      #filters{
        order: 1;
        position: sticky;
        top: 0;
        z-index: 2002;
        background: white;
        padding: 6px 10px;
        border-bottom: 1px solid #eee;
      }

      .topbar.filterbar{
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
      }

      #map{
        height: 52vh;             /* upper half of the screen */
        width: 100%;
        border-radius: 0;
      }
      #results{
        max-height: 42vh;         /* lower half; scrolls */
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        border-top: 1px solid var(--border);
        padding: 8px 10px;
        background: white;
        width: 100%;
        box-sizing: border-box;
      }
    }

    /* Utilities */
    .row-inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{ background: var(--chip); color: var(--chip-text); padding: 4px 8px; border-radius: 999px; border:1px solid var(--border); font-size:12px; }
    a{ color:#0a58ca; text-decoration: none; }
    a:hover{ text-decoration: underline; }

    

/* === Mobile tweaks: smaller type + taller map === */
@media (max-width: 767px){
  html, body { font-size: 12px; }
  #map{ height: 60vh !important; }
  #results{ max-height: 34vh !important; }
}

/* --- Fix mobile order: filters on top, map+list below --- */
@media (max-width: 767px){
  #filters{
    order: 0 !important;     /* put filters first */
    position: sticky;
    top: 0;
    z-index: 2002;
    background: white;
  }
  .layout{
    order: 1 !important;     /* map + list after filters */
    display: block;
  }
}
  </style>
</head>
<body>

  <!-- TOP CONTROLS (filters + Go) -->
  <div id="filters" class="topbar filterbar">
    <!-- Example dropdowns (replace options with your data as needed) -->
    <div class="dropdown" id="brandDD">
      <button type="button" aria-expanded="false">Brands ▾</button>
      <div class="menu" role="menu">
        <div class="row">
          <input id="brand-seedlip" type="checkbox" value="Seedlip" />
          <label for="brand-seedlip">Seedlip</label>
        </div>
        <div class="row">
          <input id="brand-ritual" type="checkbox" value="Ritual Zero Proof" />
          <label for="brand-ritual">Ritual Zero Proof</label>
        </div>
        <div class="row">
          <input id="brand-lyres" type="checkbox" value="Lyre's" />
          <label for="brand-lyres">Lyre's</label>
        </div>
      </div>
    </div>

    <div class="dropdown" id="neighborhoodDD">
      <button type="button" aria-expanded="false">Neighborhoods ▾</button>
      <div class="menu" role="menu">
        <div class="row">
          <input id="n-ues" type="checkbox" value="Upper East Side" />
          <label for="n-ues">Upper East Side</label>
        </div>
        <div class="row">
          <input id="n-midtown" type="checkbox" value="Midtown East" />
          <label for="n-midtown">Midtown East</label>
        </div>
        <div class="row">
          <input id="n-gramercy" type="checkbox" value="Gramercy" />
          <label for="n-gramercy">Gramercy</label>
        </div>
      </div>
    </div>

    <button id="goBtn" type="button">Go</button>
  </div>

  <!-- LAYOUT WRAPPER -->
  <div class="layout">
    <div id="map"></div>
    <div id="results"></div>
  </div>

  <!-- Leaflet JS (latest CDN) -->
  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"></script>

  <script>
    // ----------------------------
    // Basic data (replace with your live data source)
    // ----------------------------
    const locations = [
      { name: "Bemelman's Bar", address: "35 E 76th St, NY", lat: 40.7740, lng: -73.9636, website: "https://www.rosewoodhotels.com", brand: "Seedlip", neighborhood: "Upper East Side" },
      { name: "Bar Avant (Olly Olly Market)", address: "601 W 26th St, NY", lat: 40.7498, lng: -74.0075, website: "https://ollyollymarket.com", brand: "Lyre's", neighborhood: "Chelsea" },
      { name: "Fumo", address: "Chelsea, NY", lat: 40.7448, lng: -73.9809, website: "https://fumonyc.com", brand: "Ritual Zero Proof", neighborhood: "Chelsea" },
      { name: "Miriam", address: "Upper West Side, NY", lat: 40.7809, lng: -73.9797, website: "https://miriamrestaurant.com", brand: "Seedlip", neighborhood: "Upper West Side" },
      { name: "Sarabeth's", address: "Upper West Side, NY", lat: 40.7860, lng: -73.9770, website: "https://sarabethsrestaurants.com", brand: "Lyre's", neighborhood: "Upper West Side" }
    ];

    // ----------------------------
    // Map init
    // ----------------------------
    const map = L.map('map', {
      zoomControl: true,
      scrollWheelZoom: true
    }).setView([40.77, -73.97], 12.6);

    // Tile layer — light/desaturated (Carto Positron)
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 20,
  subdomains: 'abcd',
  attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
}).addTo(map);


    // Manhattan bounds (approx)
    const manhattanBounds = L.latLngBounds([40.680, -74.047], [40.882, -73.906]);
    map.setMaxBounds(manhattanBounds);
    map.setMinZoom(12.3);
    map.on('drag', () => {
      map.panInsideBounds(manhattanBounds, { animate: true });
    });

    // Keep a layer group for markers
    let markersLayer = L.layerGroup().addTo(map);

    // --- Custom near-black pin (#202329) and global default ---
function makePinIcon(hex = '#202329') {
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="38" viewBox="0 0 28 38">
      <path fill="${hex}" d="M14 0C6.82 0 1 5.82 1 13c0 9.75 11.4 23.4 12.01 24.13a1.25 1.25 0 0 0 1.98 0C15.6 36.4 27 22.75 27 13 27 5.82 21.18 0 14 0z"/>
      <circle cx="14" cy="13" r="5.2" fill="#fff"/>
    </svg>`;
  return L.icon({
    iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(svg),
    iconSize: [28, 38],
    iconAnchor: [14, 38],   // tip of the pin
    popupAnchor: [0, -32]
  });
}
const pinIcon = makePinIcon('#202329');

// Make ALL Leaflet markers use this by default
L.Marker.prototype.options.icon = pinIcon;
   
// --- Force all future markers to use pinIcon, even if created elsewhere/earlier ---
const __origMarkerFactory = L.marker;
L.marker = function(latlng, options) {
  const opts = options || {};
  if (!opts.icon) opts.icon = pinIcon;
  return __origMarkerFactory.call(this, latlng, opts);
};

// Recolor any markers that might already be on the map (created before override)
if (markersLayer && markersLayer.eachLayer) {
  markersLayer.eachLayer((layer) => {
    if (layer && typeof layer.setIcon === 'function') {
      layer.setIcon(pinIcon);
    }
  });
}


    // ----------------------------
    // Dropdown open/close behavior
    // ----------------------------
    function closeAllMenus() {
      document.querySelectorAll('.dropdown').forEach(dd => dd.classList.remove('open'));
      document.querySelectorAll('.dropdown > button').forEach(btn => btn.setAttribute('aria-expanded', 'false'));
    }

    document.addEventListener('click', (e) => {
      const dd = e.target.closest('.dropdown');
      const btn = e.target.closest('.dropdown > button');
      if (btn) {
        const parent = btn.parentElement;
        const willOpen = !parent.classList.contains('open');
        closeAllMenus();
        if (willOpen) {
          parent.classList.add('open');
          btn.setAttribute('aria-expanded', 'true');
        }
      } else if (!dd) {
        closeAllMenus();
      }
    });

    // ----------------------------
    // Build markers from data
    // ----------------------------
    function renderMarkers(data){
      markersLayer.clearLayers();
      const bounds = L.latLngBounds([]);
      data.forEach(loc => {
        const m = L.marker([loc.lat, loc.lng]).addTo(markersLayer);
        m.bindPopup(`
          <div style="min-width:200px">
            <div style="font-weight:600">${loc.name}</div>
            <div class="meta">${loc.address}</div>
            <div><a href="${loc.website}" target="_blank" rel="noopener">Website</a></div>
            <div class="meta">Brand: ${loc.brand||""}</div>
            <div class="meta">Neighborhood: ${loc.neighborhood||""}</div>
          </div>
        `);
        bounds.extend([loc.lat, loc.lng]);
      });
      return { count: data.length, bounds: data.length ? bounds : null };
    }

    // ----------------------------
    // Render results list
    // ----------------------------
    function renderList(data){
      const results = document.getElementById('results');
      results.innerHTML = '';
      data.forEach(loc => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <span class="card-name" onclick="map.setView([${loc.lat}, ${loc.lng}], 16); openMarkerAt(${loc.lat}, ${loc.lng});">${loc.name}</span><br/>
          ${loc.address}<br/>
          <a href="${loc.website}" target="_blank" rel="noopener">Website</a><br/>
          <span class="meta">Brand: ${loc.brand||""}</span><br/>
          <span class="meta">Neighborhood: ${loc.neighborhood||""}</span>
        `;
        results.appendChild(card);
      });
    }

    // Helper to open a marker popup at a given lat/lng
    function openMarkerAt(lat, lng){
      let found = null;
      markersLayer.eachLayer((layer) => {
        const p = layer.getLatLng();
        if (Math.abs(p.lat - lat) < 1e-6 && Math.abs(p.lng - lng) < 1e-6) {
          found = layer;
        }
      });
      if (found){ found.openPopup(); }
    }

    // ----------------------------
    // Filter logic
    // ----------------------------
    function getSelectedValues(prefix){
      return Array.from(document.querySelectorAll(`input[id^="${prefix}-"]:checked`)).map(cb => cb.value);
    }

    function applyFilters() {
      // Close any open menus
      closeAllMenus();

      const selectedBrands = getSelectedValues('brand');
      const selectedNeighborhoods = getSelectedValues('n');

      const filtered = locations.filter(loc => {
        const brandOK = selectedBrands.length ? selectedBrands.includes(loc.brand) : true;
        const hoodOK  = selectedNeighborhoods.length ? selectedNeighborhoods.includes(loc.neighborhood) : true;
        return brandOK && hoodOK;
      });

      renderList(filtered);
      const { count, bounds } = renderMarkers(filtered);

      if (count > 0 && bounds) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }

      // Store bounds for other components if needed
      window.filteredBounds = bounds;

      // On mobile, bring the results list into view under the map
      if (window.matchMedia('(max-width: 768px)').matches) {
        const resEl = document.getElementById('results') || document.getElementById('sidebar');
        if (resEl) {
          resEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Re-measure map after DOM shifts
      setTimeout(() => map.invalidateSize(true), 120);
    }

    document.getElementById('goBtn').addEventListener('click', applyFilters);

    // Initial render: show all
    renderList(locations);
    const initial = renderMarkers(locations);
    if (initial.bounds) map.fitBounds(initial.bounds, { padding:[30,30] });

    // Re-measure map after load to be safe in Wix iframe
    setTimeout(() => map.invalidateSize(), 150);

// === Fill iframe height reliably inside Wix ===
// 1) Lock <html> and <body> to the iframe's actual inner height
function lockBodyToIframeHeight() {
  const h = Math.max(
    document.documentElement.clientHeight || 0,
    window.innerHeight || 0
  );
  document.documentElement.style.height = h + 'px';
  document.body.style.height = h + 'px';
}

// 2) After we lock heights, size map + results to fill under the filters bar
function sizeMapAndList() {
  const isDesktop = window.matchMedia('(min-width: 768px)').matches;
  const mapEl = document.getElementById('map');
  const resultsEl = document.getElementById('results');
  const filtersEl = document.getElementById('filters');
  if (!mapEl || !resultsEl) return;

  if (isDesktop) {
    const filtersH = filtersEl ? filtersEl.offsetHeight : 0;
    const pad = 10;
    const h = Math.max(
      document.documentElement.clientHeight || 0,
      window.innerHeight || 0
    );
    const available = Math.max(300, Math.floor(h - filtersH - pad));
    mapEl.style.height = available + 'px';
    resultsEl.style.height = available + 'px';
    resultsEl.style.maxHeight = available + 'px';
  } else {
    mapEl.style.height = '';
    resultsEl.style.height = '';
    resultsEl.style.maxHeight = '';
  }

  setTimeout(() => map.invalidateSize(), 80);
}

// 3) Orchestrate updates
function refreshHeights() {
  lockBodyToIframeHeight();
  sizeMapAndList();
}

refreshHeights();
window.addEventListener('resize', refreshHeights);
document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshHeights(); });
const ro = new ResizeObserver(() => refreshHeights());
ro.observe(document.documentElement);
ro.observe(document.body);
document.addEventListener('click', (e) => {
  const isToggle = e.target.closest('.dropdown > button');
  const clickedOutside = !e.target.closest('.dropdown');
  if (isToggle || clickedOutside) setTimeout(refreshHeights, 50);
});
  </script>
</body>
</html>
